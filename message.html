<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.95">
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="ChatSiri Workspace">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ChatSiri Workspace">
    <meta name="description" content="Complete Enterprise Collaboration Platform">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#0a192f">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="theme-color" content="#0a192f">
    
    <!-- Title -->
    <title>ChatSiri Workspace | Complete Enterprise Collaboration</title>
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Professional ChatSiri Theme */
            --dark-blue: #0a192f;
            --medium-blue: #172a45;
            --accent-primary: #2563eb;
            --accent-secondary: #7c3aed;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --card-bg: rgba(23, 42, 69, 0.9);
            --sidebar-width: 320px;
            --topbar-height: 70px;
            --border-radius: 12px;
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            --content-max-width: 1600px;
            --online-color: #10b981;
            --away-color: #f59e0b;
            --offline-color: #6b7280;
            --background-color: #0a192f;
            --surface-color: #172a45;
            --border-color: rgba(255, 255, 255, 0.12);
            --shadow-color: rgba(0, 0, 0, 0.3);
            --shadow-elevated: 0 8px 32px rgba(0, 0, 0, 0.2);
            --task-pending: #f59e0b;
            --task-inprogress: #3b82f6;
            --task-completed: #10b981;
            --task-blocked: #ef4444;
        }

        /* Professional Themes */
        [data-theme="corporate-blue"] {
            --dark-blue: #1e3a8a;
            --medium-blue: #1e40af;
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
            --background-color: #1e3a8a;
            --surface-color: #1e40af;
            --border-color: rgba(96, 165, 250, 0.15);
            --shadow-color: rgba(0, 0, 0, 0.25);
        }

        [data-theme="executive-dark"] {
            --dark-blue: #111827;
            --medium-blue: #1f2937;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --background-color: #111827;
            --surface-color: #1f2937;
            --border-color: rgba(139, 92, 246, 0.15);
            --shadow-color: rgba(0, 0, 0, 0.35);
        }

        [data-theme="light"] {
            --dark-blue: #f1f5f9;
            --medium-blue: #ffffff;
            --accent-primary: #2563eb;
            --accent-secondary: #7c3aed;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-tertiary: #64748b;
            --card-bg: rgba(255, 255, 255, 0.95);
            --background-color: #f1f5f9;
            --surface-color: #ffffff;
            --border-color: rgba(0, 0, 0, 0.08);
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        /* System Theme Detection */
        @media (prefers-color-scheme: light) {
            :root:not([data-theme]) {
                --dark-blue: #f1f5f9;
                --medium-blue: #ffffff;
                --accent-primary: #2563eb;
                --accent-secondary: #7c3aed;
                --text-primary: #1e293b;
                --text-secondary: #475569;
                --text-tertiary: #64748b;
                --card-bg: rgba(255, 255, 255, 0.95);
                --background-color: #f1f5f9;
                --surface-color: #ffffff;
                --border-color: rgba(0, 0, 0, 0.08);
                --shadow-color: rgba(0, 0, 0, 0.1);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.5;
            font-weight: 400;
        }

        /* Enhanced Background Pattern */
        .background-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 15% 50%, rgba(37, 99, 235, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 85% 30%, rgba(124, 58, 237, 0.03) 0%, transparent 50%);
            z-index: -1;
        }

        /* Enhanced Loading Spinner */
        .loading-spinner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 25, 47, 0.95);
            backdrop-filter: blur(10px);
            z-index: 10003;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid transparent;
            border-top-color: var(--accent-primary);
            border-right-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Enhanced Top Navigation */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--topbar-height);
            background: var(--surface-color);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 28px;
            z-index: 1000;
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-elevated);
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .back-btn {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 16px;
        }

        .back-btn:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
            transform: translateX(-2px);
        }

        .brand-logo {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .brand-logo-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .brand-text {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 22px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--text-primary), var(--text-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .brand-subtitle {
            font-size: 12px;
            color: var(--text-tertiary);
            letter-spacing: 0.3px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .nav-center {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
            max-width: 600px;
            margin: 0 32px;
        }

        .nav-search {
            flex: 1;
            position: relative;
        }

        .nav-search input {
            width: 100%;
            padding: 14px 20px 14px 48px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            transition: var(--transition);
        }

        .nav-search input:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: rgba(var(--accent-primary-rgb), 0.05);
            box-shadow: 0 0 0 3px rgba(var(--accent-primary-rgb), 0.1);
        }

        .nav-search i {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
            font-size: 16px;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        /* Notification System Enhancement */
        .notification-wrapper {
            position: relative;
        }

        .notification-bell {
            position: relative;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 18px;
        }

        .notification-bell:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
            transform: translateY(-2px);
        }

        .notification-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--accent-danger);
            color: white;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 12px;
            min-width: 24px;
            height: 24px;
            text-align: center;
            font-weight: 700;
            border: 3px solid var(--surface-color);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .notification-dropdown {
            position: absolute;
            top: calc(100% + 12px);
            right: 0;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            width: 420px;
            max-height: 500px;
            overflow-y: auto;
            box-shadow: var(--shadow-elevated);
            backdrop-filter: blur(20px);
            z-index: 1001;
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .notification-dropdown.active {
            display: block;
        }

        /* Workspace Modules Navigation */
        .modules-nav {
            display: flex;
            gap: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 6px;
            margin-right: 20px;
        }

        .module-btn {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .module-btn:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .module-btn.active {
            color: var(--accent-primary);
            background: var(--surface-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Main Container */
        .workspace-container {
            margin-top: var(--topbar-height);
            min-height: calc(100vh - var(--topbar-height));
            display: flex;
            padding: 24px;
            gap: 24px;
            max-width: 1800px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Left Sidebar - Main Navigation */
        .workspace-sidebar {
            width: 320px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: calc(100vh - var(--topbar-height) - 48px);
            overflow: hidden;
            box-shadow: var(--shadow-elevated);
        }

        .sidebar-header {
            padding: 28px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }

        .sidebar-title {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 8px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .sidebar-subtitle {
            font-size: 13px;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        .sidebar-nav {
            flex: 1;
            overflow-y: auto;
            padding: 20px 0;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 11px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 28px 12px;
            font-weight: 700;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 16px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 28px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: var(--transition);
            cursor: pointer;
            border-left: 4px solid transparent;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            border-left-color: var(--accent-primary);
        }

        .nav-item.active {
            background: rgba(var(--accent-primary-rgb), 0.1);
            color: var(--accent-primary);
            border-left-color: var(--accent-primary);
        }

        .nav-icon {
            width: 20px;
            text-align: center;
            font-size: 16px;
        }

        .nav-label {
            font-size: 14px;
            font-weight: 600;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--accent-primary);
            color: white;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 10px;
            font-weight: 700;
            min-width: 24px;
            text-align: center;
        }

        /* Main Content Area */
        .workspace-main {
            flex: 1;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: calc(100vh - var(--topbar-height) - 48px);
            overflow: hidden;
            box-shadow: var(--shadow-elevated);
        }

        .module-header {
            padding: 24px 32px;
            border-bottom: 1px solid var(--border-color);
            background: var(--surface-color);
        }

        .module-title {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 8px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .module-subtitle {
            font-size: 14px;
            color: var(--text-tertiary);
        }

        .module-content {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
        }

        /* Chat Module Specific */
        .chat-area {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            background: var(--surface-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .chat-header-avatar {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 20px;
            color: white;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
        }

        .chat-header-details h3 {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .chat-header-details p {
            font-size: 14px;
            color: var(--text-tertiary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--online-color);
        }

        .status-indicator.away {
            background: var(--away-color);
        }

        .status-indicator.offline {
            background: var(--offline-color);
        }

        .chat-header-actions {
            display: flex;
            gap: 12px;
        }

        .chat-actions-btn {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 18px;
        }

        .chat-actions-btn:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
            transform: translateY(-2px);
        }

        /* Messages Container */
        .messages-container {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background: rgba(10, 25, 47, 0.3);
        }

        .message-date {
            text-align: center;
            margin: 20px 0;
        }

        .date-label {
            display: inline-block;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            font-size: 13px;
            color: var(--text-tertiary);
            font-weight: 600;
            border: 1px solid var(--border-color);
        }

        /* Message Styling */
        .message {
            display: flex;
            max-width: 75%;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.sent {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.received {
            align-self: flex-start;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            color: white;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            flex-shrink: 0;
            margin-top: 8px;
        }

        .message-content {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-width: 100%;
            margin: 0 16px;
        }

        .message-bubble {
            padding: 16px 20px;
            border-radius: 20px;
            position: relative;
            word-wrap: break-word;
            max-width: 100%;
            border: 1px solid transparent;
        }

        .message.sent .message-bubble {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border-bottom-right-radius: 8px;
            box-shadow: 0 4px 12px rgba(var(--accent-primary-rgb), 0.3);
        }

        .message.received .message-bubble {
            background: var(--surface-color);
            color: var(--text-primary);
            border-bottom-left-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .message-text {
            font-size: 15px;
            line-height: 1.6;
        }

        .message-time {
            font-size: 12px;
            opacity: 0.8;
            align-self: flex-end;
            margin-top: 4px;
            font-weight: 600;
        }

        /* File Attachments */
        .file-attachment {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-top: 12px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
        }

        .file-attachment:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .file-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: rgba(var(--accent-primary-rgb), 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-primary);
            font-size: 20px;
        }

        .file-info {
            flex: 1;
            min-width: 0;
        }

        .file-name {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-size {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* Enhanced Message Input */
        .message-input-container {
            padding: 24px 32px;
            border-top: 1px solid var(--border-color);
            background: var(--surface-color);
        }

        .message-input-wrapper {
            display: flex;
            gap: 16px;
            align-items: flex-end;
        }

        .input-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .input-action-btn {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 18px;
        }

        .input-action-btn:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
            transform: translateY(-2px);
        }

        .message-input {
            flex: 1;
            min-height: 56px;
            max-height: 150px;
            padding: 18px 24px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 28px;
            color: var(--text-primary);
            font-size: 15px;
            resize: none;
            transition: var(--transition);
            line-height: 1.6;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: rgba(var(--accent-primary-rgb), 0.05);
            box-shadow: 0 0 0 4px rgba(var(--accent-primary-rgb), 0.1);
        }

        .send-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            flex-shrink: 0;
            box-shadow: 0 6px 20px rgba(var(--accent-primary-rgb), 0.3);
            font-size: 20px;
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(var(--accent-primary-rgb), 0.4);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Right Sidebar - Enhanced */
        .workspace-rightbar {
            width: 360px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: calc(100vh - var(--topbar-height) - 48px);
            overflow: hidden;
            box-shadow: var(--shadow-elevated);
        }

        .rightbar-header {
            padding: 28px;
            border-bottom: 1px solid var(--border-color);
        }

        .rightbar-title {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 20px;
            font-weight: 800;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .rightbar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px 0;
        }

        /* Enhanced Online Users */
        .online-users-list {
            padding: 0 28px;
        }

        .online-user-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 18px;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid var(--border-color);
            border-radius: 12px;
            margin: 4px 0;
        }

        .online-user-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .online-user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            color: white;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            position: relative;
        }

        .online-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 14px;
            height: 14px;
            background: var(--online-color);
            border-radius: 50%;
            border: 3px solid var(--card-bg);
        }

        .online-user-info {
            flex: 1;
        }

        .online-user-name {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .online-user-role {
            font-size: 13px;
            color: var(--text-tertiary);
        }

        /* Enhanced Dashboard Cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            padding: 32px;
        }

        .dashboard-card {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            padding: 28px;
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .dashboard-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-4px);
            box-shadow: var(--shadow-elevated);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .card-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background: rgba(var(--accent-primary-rgb), 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--accent-primary);
        }

        .card-title {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 18px;
            font-weight: 800;
            color: var(--text-primary);
        }

        .card-value {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .card-label {
            font-size: 14px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .card-progress {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 20px;
        }

        .card-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* Enhanced Tasks System */
        .tasks-container {
            padding: 32px;
        }

        .task-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .task-item {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            padding: 24px;
            border: 1px solid var(--border-color);
            transition: var(--transition);
            cursor: pointer;
        }

        .task-item:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .task-title {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .task-priority {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .priority-high {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-danger);
        }

        .priority-medium {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent-warning);
        }

        .priority-low {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-success);
        }

        .task-description {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .task-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .task-assignee {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .assignee-avatar {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 13px;
            color: white;
        }

        .assignee-name {
            font-size: 13px;
            color: var(--text-primary);
            font-weight: 600;
        }

        .task-due-date {
            font-size: 13px;
            color: var(--text-tertiary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Enhanced Calendar */
        .calendar-container {
            padding: 32px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .calendar-month {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 24px;
            font-weight: 800;
            color: var(--text-primary);
        }

        .calendar-nav {
            display: flex;
            gap: 8px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .calendar-day-header {
            text-align: center;
            padding: 12px;
            font-size: 13px;
            font-weight: 700;
            color: var(--text-tertiary);
            text-transform: uppercase;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
        }

        .calendar-day:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .calendar-day.today {
            background: var(--accent-primary);
            color: white;
        }

        .calendar-day.event {
            background: rgba(var(--accent-secondary-rgb), 0.15);
            color: var(--accent-secondary);
        }

        /* Enhanced Connection Status */
        .connection-status {
            position: fixed;
            top: 90px;
            right: 32px;
            padding: 14px 20px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 700;
            z-index: 10001;
            display: none;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(10px);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .connection-status.online {
            background: rgba(16, 185, 129, 0.15);
            color: var(--online-color);
            border: 1px solid rgba(16, 185, 129, 0.25);
        }

        .connection-status.offline {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-danger);
            border: 1px solid rgba(239, 68, 68, 0.25);
        }

        /* Enhanced Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 10002;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            padding: 40px;
            max-width: 600px;
            width: 100%;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-elevated);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .modal-title {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 28px;
            font-weight: 800;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-tertiary);
            font-size: 24px;
            cursor: pointer;
            transition: var(--transition);
        }

        .modal-close:hover {
            color: var(--text-primary);
            transform: rotate(90deg);
        }

        /* Responsive Design */
        @media (max-width: 1600px) {
            .workspace-container {
                max-width: 1400px;
            }
        }

        @media (max-width: 1200px) {
            .workspace-rightbar {
                display: none;
            }
            
            .nav-center {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .workspace-container {
                flex-direction: column;
                padding: 16px;
                gap: 16px;
            }
            
            .workspace-sidebar {
                width: 100%;
                height: 300px;
            }
            
            .workspace-main {
                height: calc(100vh - var(--topbar-height) - 332px);
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .module-content {
                padding: 24px;
            }
        }

        @media (max-width: 576px) {
            .top-nav {
                padding: 0 20px;
            }
            
            .brand-text {
                font-size: 18px;
            }
            
            .module-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="background-pattern"></div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner"></div>
        <div class="loading-text">Initializing ChatSiri Workspace...</div>
    </div>

    <!-- Connection Status -->
    <div class="connection-status" id="connectionStatus">
        <i class="fas fa-circle"></i>
        <span>Online</span>
    </div>

    <!-- Permission Request Modal -->
    <div class="modal-overlay" id="permissionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Enable Notifications</h3>
                <button class="modal-close" id="closePermissionModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div style="text-align: center; padding: 40px 0;">
                <div style="width: 120px; height: 120px; border-radius: 30px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); display: flex; align-items: center; justify-content: center; margin: 0 auto 32px;">
                    <i class="fas fa-bell" style="font-size: 48px; color: white;"></i>
                </div>
                <h4 style="font-family: 'Plus Jakarta Sans', sans-serif; font-size: 24px; font-weight: 800; margin-bottom: 16px; color: var(--text-primary);">
                    Stay Connected
                </h4>
                <p style="color: var(--text-secondary); line-height: 1.6; margin-bottom: 32px;">
                    Get real-time notifications for messages, tasks, meetings, and important updates. 
                    Never miss critical information with instant alerts.
                </p>
                <div style="display: flex; gap: 16px; justify-content: center;">
                    <button class="permission-btn allow" id="allowNotifications" 
                            style="padding: 16px 32px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; transition: var(--transition);">
                        <i class="fas fa-check"></i> Allow Notifications
                    </button>
                    <button class="permission-btn deny" id="denyNotifications"
                            style="padding: 16px 32px; background: rgba(255, 255, 255, 0.05); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; transition: var(--transition);">
                        Maybe Later
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Creation Modal -->
    <div class="modal-overlay" id="taskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Task</h3>
                <button class="modal-close" onclick="closeModal('taskModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="taskForm">
                <div style="display: flex; flex-direction: column; gap: 24px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: var(--text-secondary);">Task Title</label>
                        <input type="text" id="taskTitle" required 
                               style="width: 100%; padding: 16px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color); border-radius: 12px; color: var(--text-primary); font-size: 16px;">
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: var(--text-secondary);">Description</label>
                        <textarea id="taskDescription" rows="4"
                                  style="width: 100%; padding: 16px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color); border-radius: 12px; color: var(--text-primary); font-size: 16px; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: var(--text-secondary);">Priority</label>
                            <select id="taskPriority"
                                    style="width: 100%; padding: 16px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color); border-radius: 12px; color: var(--text-primary); font-size: 16px;">
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: var(--text-secondary);">Due Date</label>
                            <input type="date" id="taskDueDate" required
                                   style="width: 100%; padding: 16px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color); border-radius: 12px; color: var(--text-primary); font-size: 16px;">
                        </div>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: var(--text-secondary);">Assign To</label>
                        <select id="taskAssignee"
                                style="width: 100%; padding: 16px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color); border-radius: 12px; color: var(--text-primary); font-size: 16px;">
                            <!-- Will be populated with online users -->
                        </select>
                    </div>
                    
                    <div style="display: flex; gap: 16px; justify-content: flex-end; margin-top: 32px;">
                        <button type="button" onclick="closeModal('taskModal')"
                                style="padding: 16px 32px; background: rgba(255, 255, 255, 0.05); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; transition: var(--transition);">
                            Cancel
                        </button>
                        <button type="submit"
                                style="padding: 16px 32px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; transition: var(--transition);">
                            <i class="fas fa-plus"></i> Create Task
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="nav-left">
            <button class="back-btn" id="backBtn">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="brand-logo">
                <div class="brand-logo-icon">
                    <i class="fas fa-comments"></i>
                </div>
                <div>
                    <div class="brand-text">ChatSiri Workspace</div>
                    <div class="brand-subtitle">Complete Enterprise Collaboration</div>
                </div>
            </div>
        </div>
        
        <div class="nav-center">
            <div class="nav-search">
                <i class="fas fa-search"></i>
                <input type="text" id="globalSearch" placeholder="Search messages, tasks, files...">
            </div>
        </div>
        
        <div class="nav-right">
            <!-- Workspace Modules -->
            <div class="modules-nav">
                <button class="module-btn active" data-module="chat">
                    <i class="fas fa-comments"></i>
                    <span>Chat</span>
                </button>
                <button class="module-btn" data-module="tasks">
                    <i class="fas fa-tasks"></i>
                    <span>Tasks</span>
                </button>
                <button class="module-btn" data-module="calendar">
                    <i class="fas fa-calendar"></i>
                    <span>Calendar</span>
                </button>
                <button class="module-btn" data-module="files">
                    <i class="fas fa-folder"></i>
                    <span>Files</span>
                </button>
                <button class="module-btn" data-module="analytics">
                    <i class="fas fa-chart-line"></i>
                    <span>Analytics</span>
                </button>
            </div>
            
            <!-- Notification Bell -->
            <div class="notification-wrapper">
                <button class="notification-bell" id="notificationBell">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                </button>
                <div class="notification-dropdown" id="notificationDropdown">
                    <div class="notification-header">
                        <h4 class="notification-title">Notifications</h4>
                        <button class="notification-clear" id="clearNotifications">Clear All</button>
                    </div>
                    <div class="notification-list" id="notificationList">
                        <div class="notification-empty">
                            <i class="fas fa-bell-slash"></i>
                            <p>No notifications yet</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Theme Toggle -->
            <div class="theme-toggle-wrapper" style="position: relative;">
                <button class="theme-toggle" id="themeToggle">
                    <i class="fas fa-palette"></i>
                </button>
                <div class="theme-dropdown" id="themeDropdown">
                    <div class="theme-option" data-theme="system">
                        <i class="fas fa-desktop"></i>
                        <span>System Default</span>
                    </div>
                    <div class="theme-option" data-theme="light">
                        <i class="fas fa-sun"></i>
                        <span>Light Theme</span>
                    </div>
                    <div class="theme-option" data-theme="corporate-blue">
                        <i class="fas fa-building"></i>
                        <span>Corporate Blue</span>
                    </div>
                    <div class="theme-option" data-theme="executive-dark">
                        <i class="fas fa-moon"></i>
                        <span>Executive Dark</span>
                    </div>
                </div>
            </div>
            
            <!-- User Profile -->
            <div class="user-profile" id="userProfile">
                <div class="user-avatar" id="userAvatar">CS</div>
                <div class="user-info">
                    <div class="user-name" id="userName">Administrator</div>
                    <div class="user-role" id="userRole">SYSTEM ADMIN</div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Workspace Container -->
    <div class="workspace-container">
        <!-- Left Sidebar - Navigation -->
        <div class="workspace-sidebar">
            <div class="sidebar-header">
                <h3 class="sidebar-title">
                    <i class="fas fa-rocket"></i>
                    ChatSiri
                </h3>
                <div class="sidebar-subtitle">Enterprise Workspace</div>
            </div>
            
            <div class="sidebar-nav">
                <div class="nav-section">
                    <div class="section-title">Communication</div>
                    <div class="nav-item active" data-module="chat">
                        <div class="nav-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <div class="nav-label">Team Chat</div>
                        <div class="nav-badge" id="chatBadge">0</div>
                    </div>
                    <div class="nav-item" data-module="channels">
                        <div class="nav-icon">
                            <i class="fas fa-hashtag"></i>
                        </div>
                        <div class="nav-label">Channels</div>
                        <div class="nav-badge" id="channelsBadge">5</div>
                    </div>
                    <div class="nav-item" data-module="meetings">
                        <div class="nav-icon">
                            <i class="fas fa-video"></i>
                        </div>
                        <div class="nav-label">Meetings</div>
                    </div>
                </div>
                
                <div class="nav-section">
                    <div class="section-title">Productivity</div>
                    <div class="nav-item" data-module="tasks">
                        <div class="nav-icon">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <div class="nav-label">Tasks</div>
                        <div class="nav-badge" id="tasksBadge">12</div>
                    </div>
                    <div class="nav-item" data-module="calendar">
                        <div class="nav-icon">
                            <i class="fas fa-calendar"></i>
                        </div>
                        <div class="nav-label">Calendar</div>
                        <div class="nav-badge" id="calendarBadge">3</div>
                    </div>
                    <div class="nav-item" data-module="files">
                        <div class="nav-icon">
                            <i class="fas fa-folder"></i>
                        </div>
                        <div class="nav-label">Files</div>
                        <div class="nav-badge" id="filesBadge">48</div>
                    </div>
                </div>
                
                <div class="nav-section">
                    <div class="section-title">Analytics</div>
                    <div class="nav-item" data-module="analytics">
                        <div class="nav-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="nav-label">Analytics</div>
                    </div>
                    <div class="nav-item" data-module="reports">
                        <div class="nav-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <div class="nav-label">Reports</div>
                    </div>
                    <div class="nav-item" data-module="insights">
                        <div class="nav-icon">
                            <i class="fas fa-lightbulb"></i>
                        </div>
                        <div class="nav-label">Insights</div>
                    </div>
                </div>
                
                <div class="nav-section">
                    <div class="section-title">Settings</div>
                    <div class="nav-item" data-module="settings">
                        <div class="nav-icon">
                            <i class="fas fa-cog"></i>
                        </div>
                        <div class="nav-label">Workspace Settings</div>
                    </div>
                    <div class="nav-item" data-module="members">
                        <div class="nav-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="nav-label">Team Members</div>
                    </div>
                    <div class="nav-item" data-module="integrations">
                        <div class="nav-icon">
                            <i class="fas fa-puzzle-piece"></i>
                        </div>
                        <div class="nav-label">Integrations</div>
                    </div>
                </div>
            </div>
            
            <!-- Workspace Status -->
            <div style="padding: 20px 28px; border-top: 1px solid var(--border-color);">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                    <span style="font-size: 13px; color: var(--text-tertiary);">Workspace Status</span>
                    <span style="font-size: 12px; color: var(--online-color); font-weight: 700;">
                        <i class="fas fa-circle"></i> Active
                    </span>
                </div>
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <span style="font-size: 12px; color: var(--text-tertiary);">Storage</span>
                    <span style="font-size: 12px; color: var(--text-primary); font-weight: 700;">2.4/10 GB</span>
                </div>
                <div style="height: 4px; background: rgba(255, 255, 255, 0.1); border-radius: 2px; margin-top: 8px; overflow: hidden;">
                    <div style="width: 24%; height: 100%; background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));"></div>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="workspace-main">
            <!-- Chat Module (Default) -->
            <div class="module-header" id="chatHeader">
                <div>
                    <h3 class="module-title">
                        <i class="fas fa-comments"></i>
                        Team Chat
                    </h3>
                    <p class="module-subtitle">Real-time communication with your team</p>
                </div>
                <div class="chat-header-actions">
                    <button class="chat-actions-btn" id="startGroupChat">
                        <i class="fas fa-users"></i>
                    </button>
                    <button class="chat-actions-btn" id="voiceCallBtn">
                        <i class="fas fa-phone"></i>
                    </button>
                    <button class="chat-actions-btn" id="videoCallBtn">
                        <i class="fas fa-video"></i>
                    </button>
                    <button class="chat-actions-btn" id="chatSettingsBtn">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
            
            <div class="module-content">
                <!-- Chat Interface -->
                <div class="chat-area">
                    <div class="messages-container" id="messagesContainer">
                        <!-- Messages will be loaded here -->
                    </div>
                    
                    <div class="message-input-container">
                        <div class="input-actions">
                            <button class="input-action-btn" id="attachFileBtn" title="Attach File">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <button class="input-action-btn" id="attachImageBtn" title="Attach Image">
                                <i class="fas fa-image"></i>
                            </button>
                            <button class="input-action-btn" id="recordAudioBtn" title="Record Audio">
                                <i class="fas fa-microphone"></i>
                            </button>
                            <button class="input-action-btn" id="emojiBtn" title="Emoji">
                                <i class="fas fa-smile"></i>
                            </button>
                            <button class="input-action-btn" id="formatTextBtn" title="Format Text">
                                <i class="fas fa-bold"></i>
                            </button>
                        </div>
                        <div class="message-input-wrapper">
                            <textarea class="message-input" id="messageInput" 
                                      placeholder="Type your message... Press Enter to send, Shift+Enter for new line" 
                                      rows="1"></textarea>
                            <button class="send-btn" id="sendBtn" disabled>
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Sidebar - Context Panel -->
        <div class="workspace-rightbar">
            <div class="rightbar-header">
                <h3 class="rightbar-title">
                    <i class="fas fa-users"></i>
                    Online Team
                </h3>
            </div>
            
            <div class="rightbar-content">
                <!-- Online Users -->
                <div class="online-users-list" id="onlineUsersList">
                    <!-- Online users will be loaded here -->
                </div>
                
                <!-- Quick Actions -->
                <div style="padding: 28px; border-top: 1px solid var(--border-color);">
                    <h4 style="font-family: 'Plus Jakarta Sans', sans-serif; font-size: 18px; font-weight: 800; margin-bottom: 20px; color: var(--text-primary);">
                        <i class="fas fa-bolt"></i> Quick Actions
                    </h4>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <button class="quick-action-btn" id="createTaskBtn" 
                                style="padding: 16px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color); border-radius: 12px; color: var(--text-primary); font-size: 14px; font-weight: 600; cursor: pointer; transition: var(--transition); text-align: left; display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-plus" style="color: var(--accent-primary);"></i>
                            Create Task
                        </button>
                        <button class="quick-action-btn" id="scheduleMeetingBtn"
                                style="padding: 16px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color); border-radius: 12px; color: var(--text-primary); font-size: 14px; font-weight: 600; cursor: pointer; transition: var(--transition); text-align: left; display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-calendar-plus" style="color: var(--accent-secondary);"></i>
                            Schedule Meeting
                        </button>
                        <button class="quick-action-btn" id="shareFileBtn"
                                style="padding: 16px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color); border-radius: 12px; color: var(--text-primary); font-size: 14px; font-weight: 600; cursor: pointer; transition: var(--transition); text-align: left; display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-share" style="color: var(--accent-success);"></i>
                            Share File
                        </button>
                    </div>
                </div>
                
                <!-- Recent Activity -->
                <div style="padding: 28px; border-top: 1px solid var(--border-color);">
                    <h4 style="font-family: 'Plus Jakarta Sans', sans-serif; font-size: 18px; font-weight: 800; margin-bottom: 20px; color: var(--text-primary);">
                        <i class="fas fa-history"></i> Recent Activity
                    </h4>
                    <div id="recentActivity">
                        <!-- Recent activity will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
    // ============================
    // ENHANCED USER IDENTITIES
    // ============================
    const ENHANCED_USERS = {
        'office.hog@gmail.com': {
            name: 'Central Administrator',
            photo: 'https://i.postimg.cc/3wvN3Xqc/COLLECTIONS.png',
            role: 'System Administrator',
            department: 'IT Operations',
            status: 'online',
            lastActive: Date.now(),
            permissions: ['admin', 'manage_users', 'manage_workspace']
        },
        'sales.hog@gmail.com': {
            name: 'Sales Coordinator',
            photo: 'https://i.postimg.cc/3wvN3Xqc/COLLECTIONS.png',
            role: 'Sales Executive',
            department: 'Sales & Marketing',
            status: 'online',
            lastActive: Date.now(),
            permissions: ['create_tasks', 'upload_files', 'join_meetings']
        },
        'manager@hogcreations.com': {
            name: 'Operations Director',
            photo: 'https://i.postimg.cc/9XbqzBx4/HOG-creations.png',
            role: 'Operations Manager',
            department: 'Operations',
            status: 'online',
            lastActive: Date.now(),
            permissions: ['manage_team', 'approve_tasks', 'view_analytics']
        },
        'sales@hogcreations.com': {
            name: 'Sales Director',
            photo: 'https://i.postimg.cc/9XbqzBx4/HOG-creations.png',
            role: 'Director of Sales',
            department: 'Sales',
            status: 'online',
            lastActive: Date.now(),
            permissions: ['manage_sales', 'view_reports', 'approve_deals']
        },
        'finance@hogcreations.com': {
            name: 'Finance Controller',
            photo: 'https://i.postimg.cc/9XbqzBx4/HOG-creations.png',
            role: 'Finance Manager',
            department: 'Finance',
            status: 'online',
            lastActive: Date.now(),
            permissions: ['manage_finance', 'view_budgets', 'approve_expenses']
        },
        'hr@hogcreations.com': {
            name: 'HR Manager',
            photo: 'https://i.postimg.cc/9XbqzBx4/HOG-creations.png',
            role: 'HR Director',
            department: 'Human Resources',
            status: 'online',
            lastActive: Date.now(),
            permissions: ['manage_hr', 'view_salaries', 'approve_leave']
        },
        'logistics@hogcreations.com': {
            name: 'Logistics Head',
            photo: 'https://i.postimg.cc/9XbqzBx4/HOG-creations.png',
            role: 'Logistics Manager',
            department: 'Supply Chain',
            status: 'online',
            lastActive: Date.now(),
            permissions: ['manage_logistics', 'track_shipments', 'approve_orders']
        }
    };

    // ============================
    // FIREBASE CONFIGURATION
    // ============================
    const firebaseConfig = {
        apiKey: "AIzaSyCOb4BqfiN3vt1Y13UTEpA_boCqNRH6rrQ",
        authDomain: "dsog-stores-dashboard.firebaseapp.com",
        databaseURL: "https://dsog-stores-dashboard-default-rtdb.firebaseio.com",
        projectId: "dsog-stores-dashboard",
        storageBucket: "dsog-stores-dashboard.firebasestorage.app",
        messagingSenderId: "1085972125142",
        appId: "1:1085972125142:web:9abea9ee0dd792a052c077"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();
    const storage = firebase.storage();
    const messaging = firebase.messaging();

    // ============================
    // APPLICATION VARIABLES
    // ============================
    let currentUserId = null;
    let currentUserEmail = null;
    let currentUserInfo = null;
    let currentChatId = null;
    let currentModule = 'chat';
    let isOnline = navigator.onLine;
    let conversationsListener = null;
    let messagesListener = null;
    let onlineUsersListener = null;
    let tasksListener = null;
    let notificationsListener = null;
    let uploadTask = null;
    let notificationCount = 0;
    let isInitialized = false;
    let activeUsers = new Set();
    let workspaceStats = {
        totalMessages: 0,
        totalFiles: 0,
        activeTasks: 0,
        completedTasks: 0,
        upcomingMeetings: 0
    };

    // ============================
    // ENHANCED UTILITY FUNCTIONS
    // ============================
    function getUserInfo(email) {
        if (!email) return {
            name: 'Guest User',
            photo: null,
            role: 'Guest',
            department: 'General',
            status: 'offline',
            permissions: []
        };
        
        const normalizedEmail = email.toLowerCase().trim();
        return ENHANCED_USERS[normalizedEmail] || {
            name: email.split('@')[0],
            photo: null,
            role: 'User',
            department: 'General',
            status: 'offline',
            permissions: []
        };
    }

    function getInitials(name) {
        if (!name) return 'GU';
        return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
    }

    function formatTime(timestamp) {
        if (!timestamp) return '';
        const date = new Date(timestamp);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        return date.toLocaleDateString();
    }

    function formatFileSize(bytes) {
        if (!bytes) return '';
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function showConnectionStatus(online) {
        const connectionStatus = document.getElementById('connectionStatus');
        if (online) {
            connectionStatus.innerHTML = '<i class="fas fa-circle"></i><span>Back Online</span>';
            connectionStatus.className = 'connection-status online';
        } else {
            connectionStatus.innerHTML = '<i class="fas fa-circle"></i><span>Connection Lost</span>';
            connectionStatus.className = 'connection-status offline';
        }
        
        connectionStatus.style.display = 'flex';
        setTimeout(() => {
            connectionStatus.style.display = 'none';
        }, 3000);
    }

    function showLoading(message = 'Loading...') {
        const loadingSpinner = document.getElementById('loadingSpinner');
        const loadingText = loadingSpinner.querySelector('.loading-text');
        if (loadingSpinner) {
            loadingText.textContent = message;
            loadingSpinner.style.display = 'flex';
        }
    }

    function hideLoading() {
        const loadingSpinner = document.getElementById('loadingSpinner');
        if (loadingSpinner) {
            loadingSpinner.style.display = 'none';
        }
    }

    function showError(message) {
        console.error('Error:', message);
        // Create error notification
        showInAppNotification('Error', message, 'error');
        hideLoading();
    }

    function showSuccess(message) {
        showInAppNotification('Success', message, 'success');
    }

    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }
    }

    // ============================
    // ENHANCED NOTIFICATION SYSTEM
    // ============================
    async function requestNotificationPermission() {
        try {
            if (!('Notification' in window)) {
                console.log('This browser does not support notifications');
                return false;
            }

            if (Notification.permission === 'granted') {
                return true;
            } else if (Notification.permission === 'denied') {
                console.log('Notification permission denied');
                return false;
            } else {
                const permission = await Notification.requestPermission();
                return permission === 'granted';
            }
        } catch (error) {
            console.error('Error requesting notification permission:', error);
            return false;
        }
    }

    function showInAppNotification(title, message, type = 'info') {
        try {
            const notificationList = document.getElementById('notificationList');
            const notificationBadge = document.getElementById('notificationBadge');
            
            // Create notification item
            const notificationItem = document.createElement('div');
            notificationItem.className = 'notification-item unread';
            notificationItem.dataset.id = Date.now();
            notificationItem.dataset.type = type;
            
            const iconMap = {
                'info': 'fa-info-circle',
                'success': 'fa-check-circle',
                'warning': 'fa-exclamation-triangle',
                'error': 'fa-times-circle',
                'message': 'fa-comment',
                'task': 'fa-tasks',
                'file': 'fa-file',
                'meeting': 'fa-calendar'
            };
            
            const icon = iconMap[type] || 'fa-bell';
            const iconColor = type === 'success' ? 'var(--accent-success)' : 
                            type === 'error' ? 'var(--accent-danger)' : 
                            type === 'warning' ? 'var(--accent-warning)' : 
                            'var(--accent-primary)';
            
            notificationItem.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 16px;">
                    <div class="notification-icon" style="background: rgba(${getComputedStyle(document.documentElement).getPropertyValue(`--${type}-rgb`) || '37, 99, 235'}, 0.15);">
                        <i class="fas ${icon}" style="color: ${iconColor};"></i>
                    </div>
                    <div class="notification-content" style="flex: 1;">
                        <div class="notification-message">
                            <strong>${title}</strong><br>
                            ${message}
                        </div>
                        <div class="notification-time">Just now</div>
                    </div>
                </div>
            `;
            
            // Add click handler
            notificationItem.addEventListener('click', () => {
                notificationItem.classList.remove('unread');
                updateNotificationBadge(-1);
            });
            
            // Add to top of list
            if (notificationList) {
                // Remove empty state if present
                const emptyState = notificationList.querySelector('.notification-empty');
                if (emptyState) {
                    emptyState.remove();
                }
                
                notificationList.insertBefore(notificationItem, notificationList.firstChild);
                
                // Keep only last 20 notifications
                const items = notificationList.querySelectorAll('.notification-item');
                if (items.length > 20) {
                    items[items.length - 1].remove();
                }
            }
            
            // Update badge with animation
            updateNotificationBadge(1);
            
            // Show desktop notification if permission granted
            if (Notification.permission === 'granted') {
                new Notification(title, {
                    body: message,
                    icon: '/favicon.ico',
                    tag: 'chatsiri-notification'
                });
            }
            
            // Play notification sound
            playNotificationSound();
            
        } catch (error) {
            console.error('Error showing in-app notification:', error);
        }
    }

    function playNotificationSound() {
        try {
            // Create audio context for notification sound
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.1);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        } catch (error) {
            console.error('Error playing notification sound:', error);
        }
    }

    function updateNotificationBadge(change) {
        notificationCount = Math.max(0, notificationCount + change);
        const badge = document.getElementById('notificationBadge');
        
        if (badge) {
            if (notificationCount > 0) {
                badge.textContent = notificationCount > 99 ? '99+' : notificationCount;
                badge.style.display = 'flex';
                
                // Add animation
                badge.style.animation = 'pulse 0.5s ease-in-out';
                setTimeout(() => {
                    badge.style.animation = '';
                }, 500);
            } else {
                badge.style.display = 'none';
            }
        }
    }

    // ============================
    // ENHANCED FILE UPLOAD SYSTEM
    // ============================
    async function uploadFile(file, isImage = false) {
        if (!file || !currentUserId) return null;
        
        try {
            // Create upload progress indicator
            const uploadIndicator = document.createElement('div');
            uploadIndicator.className = 'upload-indicator';
            uploadIndicator.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background: var(--surface-color); border-radius: 12px; border: 1px solid var(--border-color); margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 40px; height: 40px; border-radius: 8px; background: rgba(var(--accent-primary-rgb), 0.15); display: flex; align-items: center; justify-content: center; color: var(--accent-primary);">
                            <i class="fas fa-upload"></i>
                        </div>
                        <div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);">${file.name}</div>
                            <div style="font-size: 12px; color: var(--text-tertiary);">Uploading...</div>
                        </div>
                    </div>
                    <div style="width: 80px; height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 3px; overflow: hidden;">
                        <div id="uploadProgress" style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary)); transition: width 0.3s ease;"></div>
                    </div>
                </div>
            `;
            
            const messageInputContainer = document.getElementById('messageInputContainer');
            if (messageInputContainer) {
                messageInputContainer.insertBefore(uploadIndicator, messageInputContainer.firstChild);
            }
            
            // Create unique file name
            const timestamp = Date.now();
            const randomString = Math.random().toString(36).substring(2, 15);
            const fileExtension = file.name.split('.').pop();
            const fileName = `${timestamp}_${randomString}.${fileExtension}`;
            const filePath = `workspace_files/${currentUserId}/${fileName}`;
            
            // Create storage reference
            const storageRef = storage.ref(filePath);
            
            // Create upload task
            uploadTask = storageRef.put(file);
            
            return new Promise((resolve, reject) => {
                uploadTask.on('state_changed',
                    (snapshot) => {
                        // Update progress
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        const progressBar = uploadIndicator.querySelector('#uploadProgress');
                        if (progressBar) {
                            progressBar.style.width = progress + '%';
                        }
                    },
                    (error) => {
                        console.error('Upload error:', error);
                        uploadIndicator.remove();
                        showError('File upload failed');
                        reject(error);
                    },
                    async () => {
                        try {
                            const downloadURL = await storageRef.getDownloadURL();
                            
                            // Get file metadata
                            const metadata = await storageRef.getMetadata();
                            
                            // Store file info in database
                            await database.ref(`workspace_files/${currentUserId}/${timestamp}`).set({
                                name: file.name,
                                url: downloadURL,
                                size: file.size,
                                type: file.type,
                                isImage: isImage,
                                uploadedAt: timestamp,
                                path: filePath,
                                contentType: metadata.contentType
                            });
                            
                            // Update workspace stats
                            workspaceStats.totalFiles++;
                            updateWorkspaceStats();
                            
                            // Remove upload indicator
                            uploadIndicator.remove();
                            
                            // Show success notification
                            showInAppNotification('File Uploaded', `${file.name} uploaded successfully`, 'success');
                            
                            resolve({
                                url: downloadURL,
                                name: file.name,
                                size: file.size,
                                type: file.type,
                                isImage: isImage,
                                path: filePath
                            });
                            
                        } catch (urlError) {
                            console.error('Error getting download URL:', urlError);
                            uploadIndicator.remove();
                            showError('Failed to get file URL');
                            reject(urlError);
                        }
                    }
                );
            });
        } catch (error) {
            console.error('Upload initialization error:', error);
            showError('Failed to start upload');
            return null;
        }
    }

    // ============================
    // ENHANCED MESSAGING SYSTEM
    // ============================
    async function sendMessage(text, fileData = null) {
        if (!currentChatId || (!text.trim() && !fileData)) return;
        
        try {
            let messageData = {
                senderId: currentUserId,
                senderInfo: currentUserInfo,
                text: text.trim(),
                timestamp: Date.now(),
                read: false,
                edited: false,
                reactions: {},
                type: fileData ? (fileData.isImage ? 'image' : 'file') : 'text'
            };
            
            if (fileData) {
                messageData.fileUrl = fileData.url;
                messageData.fileName = fileData.name;
                messageData.fileSize = fileData.size;
                messageData.fileType = fileData.type;
                messageData.filePath = fileData.path;
                
                if (fileData.isImage) {
                    messageData.imageUrl = fileData.url;
                    messageData.imageDimensions = await getImageDimensions(fileData.url);
                }
            }
            
            // Add message to database
            const messageRef = database.ref(`messages/${currentChatId}`).push();
            await messageRef.set(messageData);
            
            // Update conversation last message
            await database.ref(`conversations/${currentChatId}`).update({
                lastMessage: {
                    text: messageData.text || (messageData.type === 'file' ? 'Shared a file' : 'Shared an image'),
                    timestamp: messageData.timestamp,
                    senderId: currentUserId,
                    senderName: currentUserInfo.name
                },
                updatedAt: Date.now(),
                lastActivity: Date.now()
            });
            
            // Update workspace stats
            workspaceStats.totalMessages++;
            updateWorkspaceStats();
            
            // Clear input and reset
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            if (messageInput) {
                messageInput.value = '';
                messageInput.style.height = 'auto';
            }
            if (sendBtn) sendBtn.disabled = true;
            
            // Notify other participants
            await notifyMessageRecipients(currentChatId, messageData);
            
        } catch (error) {
            console.error('Error sending message:', error);
            showError('Failed to send message');
        }
    }

    async function notifyMessageRecipients(chatId, message) {
        try {
            const conversation = await database.ref(`conversations/${chatId}`).once('value');
            const data = conversation.val();
            
            if (data && data.participants) {
                Object.keys(data.participants).forEach(userId => {
                    if (userId !== currentUserId) {
                        // Create notification
                        database.ref(`notifications/${userId}`).push().set({
                            type: 'message',
                            title: `New message from ${currentUserInfo.name}`,
                            message: message.text || (message.type === 'file' ? 'Shared a file' : 'Shared an image'),
                            chatId: chatId,
                            senderId: currentUserId,
                            senderName: currentUserInfo.name,
                            timestamp: Date.now(),
                            read: false
                        });
                    }
                });
            }
        } catch (error) {
            console.error('Error notifying recipients:', error);
        }
    }

    async function getImageDimensions(url) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = function() {
                resolve({
                    width: this.width,
                    height: this.height
                });
            };
            img.onerror = function() {
                resolve({ width: 0, height: 0 });
            };
            img.src = url;
        });
    }

    // ============================
    // TASK MANAGEMENT SYSTEM
    // ============================
    async function createTask(taskData) {
        try {
            const taskId = database.ref('tasks').push().key;
            const fullTaskData = {
                ...taskData,
                id: taskId,
                createdBy: currentUserId,
                createdByName: currentUserInfo.name,
                createdAt: Date.now(),
                updatedAt: Date.now(),
                status: 'pending',
                progress: 0,
                comments: [],
                attachments: []
            };
            
            await database.ref(`tasks/${taskId}`).set(fullTaskData);
            
            // Notify assignee
            if (taskData.assigneeId && taskData.assigneeId !== currentUserId) {
                await database.ref(`notifications/${taskData.assigneeId}`).push().set({
                    type: 'task',
                    title: 'New Task Assigned',
                    message: `You have been assigned a new task: ${taskData.title}`,
                    taskId: taskId,
                    assignedBy: currentUserInfo.name,
                    timestamp: Date.now(),
                    read: false
                });
            }
            
            // Update workspace stats
            workspaceStats.activeTasks++;
            updateWorkspaceStats();
            
            // Show success notification
            showInAppNotification('Task Created', `Task "${taskData.title}" created successfully`, 'success');
            
            return taskId;
        } catch (error) {
            console.error('Error creating task:', error);
            showError('Failed to create task');
            return null;
        }
    }

    async function loadTasks() {
        try {
            const tasksSnapshot = await database.ref('tasks')
                .orderByChild('createdAt')
                .limitToLast(50)
                .once('value');
            
            const tasks = tasksSnapshot.val();
            const container = document.getElementById('tasksContainer');
            
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!tasks) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: var(--text-tertiary);">
                        <i class="fas fa-tasks" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                        <p>No tasks yet</p>
                        <p style="font-size: 14px; margin-top: 8px;">Create your first task!</p>
                    </div>
                `;
                return;
            }
            
            // Convert to array and sort
            const tasksArray = Object.entries(tasks)
                .map(([id, task]) => ({ id, ...task }))
                .sort((a, b) => b.createdAt - a.createdAt);
            
            tasksArray.forEach(task => {
                const taskElement = createTaskElement(task);
                container.appendChild(taskElement);
            });
            
        } catch (error) {
            console.error('Error loading tasks:', error);
        }
    }

    function createTaskElement(task) {
        const div = document.createElement('div');
        div.className = 'task-item';
        div.dataset.taskId = task.id;
        
        const priorityClass = `priority-${task.priority || 'medium'}`;
        const dueDate = task.dueDate ? new Date(task.dueDate).toLocaleDateString() : 'No due date';
        const assigneeName = task.assigneeName || 'Unassigned';
        
        div.innerHTML = `
            <div class="task-header">
                <h4 class="task-title">${task.title}</h4>
                <span class="task-priority ${priorityClass}">
                    ${task.priority || 'medium'}
                </span>
            </div>
            <div class="task-description">
                ${task.description || 'No description'}
            </div>
            <div class="task-footer">
                <div class="task-assignee">
                    <div class="assignee-avatar">${getInitials(assigneeName)}</div>
                    <div class="assignee-name">${assigneeName}</div>
                </div>
                <div class="task-due-date">
                    <i class="fas fa-calendar"></i>
                    ${dueDate}
                </div>
            </div>
        `;
        
        div.addEventListener('click', () => openTaskDetails(task));
        return div;
    }

    // ============================
    // WORKSPACE STATISTICS
    // ============================
    async function updateWorkspaceStats() {
        try {
            // Update dashboard cards
            const statsElements = {
                'onlineCount': activeUsers.size,
                'messageCount': workspaceStats.totalMessages,
                'fileCount': workspaceStats.totalFiles,
                'taskCount': workspaceStats.activeTasks
            };
            
            Object.entries(statsElements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            });
            
            // Store in database
            await database.ref(`workspace_stats/${currentUserId}`).update({
                lastUpdated: Date.now(),
                ...workspaceStats
            });
            
        } catch (error) {
            console.error('Error updating workspace stats:', error);
        }
    }

    async function loadWorkspaceStats() {
        try {
            const statsSnapshot = await database.ref(`workspace_stats/${currentUserId}`).once('value');
            const stats = statsSnapshot.val();
            
            if (stats) {
                workspaceStats = { ...workspaceStats, ...stats };
            }
            
            updateWorkspaceStats();
            
        } catch (error) {
            console.error('Error loading workspace stats:', error);
        }
    }

    // ============================
    // INITIALIZATION
    // ============================
    document.addEventListener('DOMContentLoaded', () => {
        console.log('Initializing ChatSiri Workspace...');
        
        // Show loading
        showLoading('Initializing workspace...');
        
        // Setup auth state observer
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            
            try {
                // Set user info
                currentUserId = user.uid;
                currentUserEmail = user.email;
                currentUserInfo = getUserInfo(user.email);
                
                // Update UI
                updateUserInterface();
                
                // Set online status
                await setOnlineStatus();
                
                // Initialize workspace
                await initializeWorkspace();
                
                // Setup event listeners
                setupEventListeners();
                
                // Hide loading
                hideLoading();
                
                // Show welcome notification
                showInAppNotification(
                    'Welcome to ChatSiri Workspace',
                    `You're now connected as ${currentUserInfo.name}`,
                    'success'
                );
                
            } catch (error) {
                console.error('Initialization error:', error);
                showError('Failed to initialize workspace');
            }
        });
        
        // Setup network listeners
        setupNetworkListeners();
    });

    async function initializeWorkspace() {
        try {
            // Load initial data
            await Promise.all([
                loadConversations(),
                loadOnlineUsers(),
                loadWorkspaceStats(),
                loadRecentActivity(),
                requestNotificationPermission()
            ]);
            
            // Setup real-time listeners
            setupRealtimeListeners();
            
            console.log('Workspace initialized successfully');
            
        } catch (error) {
            console.error('Error initializing workspace:', error);
            throw error;
        }
    }

    function updateUserInterface() {
        // Update user info
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const userRole = document.getElementById('userRole');
        
        if (userAvatar) userAvatar.textContent = getInitials(currentUserInfo.name);
        if (userName) userName.textContent = currentUserInfo.name;
        if (userRole) userRole.textContent = currentUserInfo.role.toUpperCase();
        
        // Update welcome message
        const welcomeMessage = document.querySelector('.module-subtitle');
        if (welcomeMessage) {
            welcomeMessage.textContent = `Welcome, ${currentUserInfo.name}!`;
        }
    }

    async function setOnlineStatus() {
        try {
            await database.ref(`userStatus/${currentUserId}`).set({
                status: 'online',
                lastSeen: Date.now(),
                name: currentUserInfo.name,
                email: currentUserEmail,
                role: currentUserInfo.role,
                department: currentUserInfo.department
            });
            
            // Setup presence system
            const userStatusRef = database.ref(`userStatus/${currentUserId}`);
            const offlineStatus = {
                status: 'offline',
                lastSeen: Date.now()
            };
            
            // Update status when user goes offline
            database.ref('.info/connected').on('value', (snapshot) => {
                if (snapshot.val() === false) {
                    userStatusRef.update(offlineStatus);
                }
            });
            
            // Clean up on page unload
            window.addEventListener('beforeunload', () => {
                userStatusRef.update(offlineStatus);
            });
            
        } catch (error) {
            console.error('Error setting online status:', error);
        }
    }

    function setupNetworkListeners() {
        window.addEventListener('online', () => {
            showConnectionStatus(true);
            if (currentUserId) {
                database.ref(`userStatus/${currentUserId}/status`).set('online');
            }
        });
        
        window.addEventListener('offline', () => {
            showConnectionStatus(false);
            if (currentUserId) {
                database.ref(`userStatus/${currentUserId}/status`).set('offline');
            }
        });
    }

    function setupRealtimeListeners() {
        // Listen for online users
        onlineUsersListener = database.ref('userStatus')
            .orderByChild('status')
            .equalTo('online')
            .on('value', (snapshot) => {
                const users = snapshot.val();
                updateOnlineUsers(users);
            });
        
        // Listen for notifications
        notificationsListener = database.ref(`notifications/${currentUserId}`)
            .orderByChild('timestamp')
            .limitToLast(20)
            .on('child_added', (snapshot) => {
                const notification = snapshot.val();
                showInAppNotification(notification.title, notification.message, notification.type);
            });
    }

    function updateOnlineUsers(users) {
        const container = document.getElementById('onlineUsersList');
        if (!container) return;
        
        container.innerHTML = '';
        activeUsers.clear();
        
        if (!users) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--text-tertiary);">
                    <p>No users online</p>
                </div>
            `;
            return;
        }
        
        Object.entries(users).forEach(([userId, data]) => {
            if (userId !== currentUserId) {
                activeUsers.add(userId);
                const userInfo = getUserInfo(data.email);
                const div = document.createElement('div');
                div.className = 'online-user-item';
                div.innerHTML = `
                    <div class="online-user-avatar">
                        ${getInitials(userInfo.name)}
                        <div class="online-indicator"></div>
                    </div>
                    <div class="online-user-info">
                        <div class="online-user-name">${userInfo.name}</div>
                        <div class="online-user-role">${userInfo.role}</div>
                    </div>
                `;
                container.appendChild(div);
            }
        });
        
        // Update online count
        updateWorkspaceStats();
    }

    // ============================
    // EVENT LISTENERS SETUP
    // ============================
    function setupEventListeners() {
        console.log('Setting up event listeners...');
        
        // Message input
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        
        if (messageInput && sendBtn) {
            messageInput.addEventListener('input', () => {
                sendBtn.disabled = !messageInput.value.trim();
                autoResizeTextarea();
            });
            
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (messageInput.value.trim()) {
                        sendMessage(messageInput.value);
                    }
                }
            });
            
            sendBtn.addEventListener('click', () => {
                if (messageInput.value.trim()) {
                    sendMessage(messageInput.value);
                }
            });
        }
        
        // File attachments
        const attachFileBtn = document.getElementById('attachFileBtn');
        const attachImageBtn = document.getElementById('attachImageBtn');
        
        if (attachFileBtn) {
            attachFileBtn.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '*/*';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            const fileData = await uploadFile(file, false);
                            if (fileData) {
                                await sendMessage('', fileData);
                            }
                        } catch (error) {
                            console.error('File upload failed:', error);
                        }
                    }
                };
                input.click();
            });
        }
        
        if (attachImageBtn) {
            attachImageBtn.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            const fileData = await uploadFile(file, true);
                            if (fileData) {
                                await sendMessage('', fileData);
                            }
                        } catch (error) {
                            console.error('Image upload failed:', error);
                        }
                    }
                };
                input.click();
            });
        }
        
        // Module navigation
        document.querySelectorAll('.module-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const module = btn.dataset.module;
                switchModule(module);
            });
        });
        
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const module = item.dataset.module;
                switchModule(module);
            });
        });
        
        // Quick actions
        const createTaskBtn = document.getElementById('createTaskBtn');
        if (createTaskBtn) {
            createTaskBtn.addEventListener('click', () => {
                openModal('taskModal');
                populateTaskAssignees();
            });
        }
        
        // Task form
        const taskForm = document.getElementById('taskForm');
        if (taskForm) {
            taskForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const taskData = {
                    title: document.getElementById('taskTitle').value,
                    description: document.getElementById('taskDescription').value,
                    priority: document.getElementById('taskPriority').value,
                    dueDate: document.getElementById('taskDueDate').value,
                    assigneeId: document.getElementById('taskAssignee').value,
                    assigneeName: document.getElementById('taskAssignee').selectedOptions[0].text
                };
                
                const taskId = await createTask(taskData);
                if (taskId) {
                    closeModal('taskModal');
                    taskForm.reset();
                    
                    // Reload tasks if on tasks module
                    if (currentModule === 'tasks') {
                        loadTasks();
                    }
                }
            });
        }
        
        // Notification bell
        const notificationBell = document.getElementById('notificationBell');
        const notificationDropdown = document.getElementById('notificationDropdown');
        
        if (notificationBell && notificationDropdown) {
            notificationBell.addEventListener('click', (e) => {
                e.stopPropagation();
                notificationDropdown.classList.toggle('active');
            });
        }
        
        // Clear notifications
        const clearNotifications = document.getElementById('clearNotifications');
        if (clearNotifications) {
            clearNotifications.addEventListener('click', () => {
                database.ref(`notifications/${currentUserId}`).remove();
                const notificationList = document.getElementById('notificationList');
                if (notificationList) {
                    notificationList.innerHTML = `
                        <div class="notification-empty">
                            <i class="fas fa-bell-slash"></i>
                            <p>No notifications yet</p>
                        </div>
                    `;
                }
                updateNotificationBadge(-notificationCount);
            });
        }
        
        // Theme toggle
        const themeToggle = document.getElementById('themeToggle');
        const themeDropdown = document.getElementById('themeDropdown');
        
        if (themeToggle && themeDropdown) {
            themeToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                themeDropdown.classList.toggle('active');
            });
            
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', () => {
                    const theme = option.dataset.theme;
                    document.documentElement.setAttribute('data-theme', theme);
                    localStorage.setItem('chatsiri-theme', theme);
                    themeDropdown.classList.remove('active');
                });
            });
        }
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (notificationDropdown && !e.target.closest('.notification-wrapper')) {
                notificationDropdown.classList.remove('active');
            }
            if (themeDropdown && !e.target.closest('.theme-toggle-wrapper')) {
                themeDropdown.classList.remove('active');
            }
        });
        
        // Global search
        const globalSearch = document.getElementById('globalSearch');
        if (globalSearch) {
            globalSearch.addEventListener('input', debounce((e) => {
                performSearch(e.target.value);
            }, 300));
        }
        
        // Back button
        const backBtn = document.getElementById('backBtn');
        if (backBtn) {
            backBtn.addEventListener('click', () => {
                if (currentChatId) {
                    closeChat();
                } else {
                    window.location.href = 'index.html';
                }
            });
        }
        
        console.log('Event listeners setup complete');
    }

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    function autoResizeTextarea() {
        const textarea = document.getElementById('messageInput');
        if (textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
        }
    }

    function switchModule(module) {
        currentModule = module;
        
        // Update active states
        document.querySelectorAll('.module-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.module === module);
        });
        
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.toggle('active', item.dataset.module === module);
        });
        
        // Update module header
        const moduleHeader = document.getElementById('chatHeader');
        if (moduleHeader) {
            const moduleTitles = {
                'chat': 'Team Chat',
                'tasks': 'Tasks & Projects',
                'calendar': 'Calendar & Meetings',
                'files': 'Files & Documents',
                'analytics': 'Analytics & Reports',
                'settings': 'Workspace Settings'
            };
            
            moduleHeader.querySelector('.module-title').innerHTML = `
                <i class="fas fa-${getModuleIcon(module)}"></i>
                ${moduleTitles[module] || module}
            `;
            moduleHeader.querySelector('.module-subtitle').textContent = getModuleDescription(module);
        }
        
        // Load module content
        loadModuleContent(module);
    }

    function getModuleIcon(module) {
        const icons = {
            'chat': 'comments',
            'tasks': 'tasks',
            'calendar': 'calendar',
            'files': 'folder',
            'analytics': 'chart-line',
            'settings': 'cog',
            'channels': 'hashtag',
            'meetings': 'video',
            'reports': 'chart-bar',
            'insights': 'lightbulb',
            'members': 'users',
            'integrations': 'puzzle-piece'
        };
        return icons[module] || 'cog';
    }

    function getModuleDescription(module) {
        const descriptions = {
            'chat': 'Real-time communication with your team',
            'tasks': 'Manage projects and track progress',
            'calendar': 'Schedule meetings and events',
            'files': 'Share and organize documents',
            'analytics': 'Workspace insights and metrics',
            'settings': 'Configure your workspace preferences'
        };
        return descriptions[module] || '';
    }

    async function loadModuleContent(module) {
        const moduleContent = document.querySelector('.module-content');
        if (!moduleContent) return;
        
        showLoading(`Loading ${module}...`);
        
        try {
            switch (module) {
                case 'chat':
                    moduleContent.innerHTML = `
                        <div class="chat-area">
                            <div class="messages-container" id="messagesContainer">
                                <div style="text-align: center; padding: 60px; color: var(--text-tertiary);">
                                    <i class="fas fa-comments" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                                    <p>Select a conversation to start chatting</p>
                                </div>
                            </div>
                            <div class="message-input-container">
                                <div class="input-actions">
                                    <button class="input-action-btn" id="attachFileBtn" title="Attach File">
                                        <i class="fas fa-paperclip"></i>
                                    </button>
                                    <button class="input-action-btn" id="attachImageBtn" title="Attach Image">
                                        <i class="fas fa-image"></i>
                                    </button>
                                    <button class="input-action-btn" id="recordAudioBtn" title="Record Audio">
                                        <i class="fas fa-microphone"></i>
                                    </button>
                                    <button class="input-action-btn" id="emojiBtn" title="Emoji">
                                        <i class="fas fa-smile"></i>
                                    </button>
                                    <button class="input-action-btn" id="formatTextBtn" title="Format Text">
                                        <i class="fas fa-bold"></i>
                                    </button>
                                </div>
                                <div class="message-input-wrapper">
                                    <textarea class="message-input" id="messageInput" 
                                              placeholder="Type your message... Press Enter to send, Shift+Enter for new line" 
                                              rows="1"></textarea>
                                    <button class="send-btn" id="sendBtn" disabled>
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    // Re-attach event listeners
                    setTimeout(() => {
                        setupEventListeners();
                    }, 100);
                    break;
                    
                case 'tasks':
                    moduleContent.innerHTML = `
                        <div class="tasks-container">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
                                <h4 style="font-family: 'Plus Jakarta Sans', sans-serif; font-size: 24px; font-weight: 800; color: var(--text-primary);">
                                    All Tasks
                                </h4>
                                <button id="createNewTaskBtn" 
                                        style="padding: 12px 24px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; border: none; border-radius: 12px; font-size: 14px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-plus"></i>
                                    New Task
                                </button>
                            </div>
                            <div class="task-list" id="tasksContainer">
                                <!-- Tasks will be loaded here -->
                            </div>
                        </div>
                    `;
                    loadTasks();
                    break;
                    
                case 'calendar':
                    moduleContent.innerHTML = `
                        <div class="calendar-container">
                            <div class="calendar-header">
                                <h4 class="calendar-month">January 2024</h4>
                                <div class="calendar-nav">
                                    <button class="calendar-nav-btn">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <button class="calendar-nav-btn">
                                        Today
                                    </button>
                                    <button class="calendar-nav-btn">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="calendar-grid">
                                <!-- Calendar will be loaded here -->
                            </div>
                        </div>
                    `;
                    loadCalendar();
                    break;
                    
                default:
                    moduleContent.innerHTML = `
                        <div style="text-align: center; padding: 80px; color: var(--text-tertiary);">
                            <i class="fas fa-cog fa-spin" style="font-size: 48px; margin-bottom: 20px;"></i>
                            <p>${module.charAt(0).toUpperCase() + module.slice(1)} module is coming soon!</p>
                        </div>
                    `;
            }
        } catch (error) {
            console.error(`Error loading ${module} module:`, error);
            showError(`Failed to load ${module} module`);
        } finally {
            hideLoading();
        }
    }

    async function loadRecentActivity() {
        try {
            const recentActivity = document.getElementById('recentActivity');
            if (!recentActivity) return;
            
            // Simulate recent activity loading
            recentActivity.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 16px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 8px; height: 8px; background: var(--accent-primary); border-radius: 50%;"></div>
                        <div>
                            <div style="font-size: 13px; color: var(--text-primary); font-weight: 600;">New message in General</div>
                            <div style="font-size: 12px; color: var(--text-tertiary);">2 minutes ago</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 8px; height: 8px; background: var(--accent-success); border-radius: 50%;"></div>
                        <div>
                            <div style="font-size: 13px; color: var(--text-primary); font-weight: 600;">Task completed</div>
                            <div style="font-size: 12px; color: var(--text-tertiary);">1 hour ago</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 8px; height: 8px; background: var(--accent-secondary); border-radius: 50%;"></div>
                        <div>
                            <div style="font-size: 13px; color: var(--text-primary); font-weight: 600;">File uploaded</div>
                            <div style="font-size: 12px; color: var(--text-tertiary);">3 hours ago</div>
                        </div>
                    </div>
                </div>
            `;
            
        } catch (error) {
            console.error('Error loading recent activity:', error);
        }
    }

    function populateTaskAssignees() {
        const assigneeSelect = document.getElementById('taskAssignee');
        if (!assigneeSelect) return;
        
        assigneeSelect.innerHTML = '';
        
        // Add current user
        const currentUserOption = document.createElement('option');
        currentUserOption.value = currentUserId;
        currentUserOption.textContent = `${currentUserInfo.name} (You)`;
        assigneeSelect.appendChild(currentUserOption);
        
        // Add online users
        activeUsers.forEach(userId => {
            // In a real app, you would fetch user details from database
            const option = document.createElement('option');
            option.value = userId;
            option.textContent = `User ${userId.substring(0, 8)}`;
            assigneeSelect.appendChild(option);
        });
    }

    function performSearch(query) {
        if (!query.trim()) return;
        
        console.log('Searching for:', query);
        // Implement search functionality here
        showInAppNotification('Search', `Searching for "${query}"`, 'info');
    }

    function closeChat() {
        currentChatId = null;
        // Reset chat interface
        const messagesContainer = document.getElementById('messagesContainer');
        if (messagesContainer) {
            messagesContainer.innerHTML = `
                <div style="text-align: center; padding: 60px; color: var(--text-tertiary);">
                    <i class="fas fa-comments" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                    <p>Select a conversation to start chatting</p>
                </div>
            `;
        }
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('chatsiri-theme');
    if (savedTheme) {
        document.documentElement.setAttribute('data-theme', savedTheme);
    }

    </script>
</body>
</html>
