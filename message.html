<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.95">
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="Jasiri E-Hub">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Jasiri E-Hub">
    <meta name="description" content="Enterprise Collaboration Suite">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#0a192f">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="theme-color" content="#0a192f">
    
    <!-- Title -->
    <title>Jasiri Workspace | Enterprise Collaboration</title>
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Professional Jasiri Theme - Corporate Dark */
            --dark-blue: #0a192f;
            --medium-blue: #172a45;
            --accent-primary: #2563eb;
            --accent-secondary: #7c3aed;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --card-bg: rgba(23, 42, 69, 0.9);
            --sidebar-width: 280px;
            --topbar-height: 64px;
            --border-radius: 12px;
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            --content-max-width: 1400px;
            --online-color: #10b981;
            --away-color: #f59e0b;
            --offline-color: #6b7280;
            --background-color: #0a192f;
            --surface-color: #172a45;
            --border-color: rgba(255, 255, 255, 0.12);
            --shadow-color: rgba(0, 0, 0, 0.3);
            --shadow-elevated: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        /* Professional Theme 1: Corporate Blue */
        [data-theme="corporate-blue"] {
            --dark-blue: #1e3a8a;
            --medium-blue: #1e40af;
            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
            --background-color: #1e3a8a;
            --surface-color: #1e40af;
            --border-color: rgba(96, 165, 250, 0.15);
            --shadow-color: rgba(0, 0, 0, 0.25);
        }

        /* Professional Theme 2: Executive Dark */
        [data-theme="executive-dark"] {
            --dark-blue: #111827;
            --medium-blue: #1f2937;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --background-color: #111827;
            --surface-color: #1f2937;
            --border-color: rgba(139, 92, 246, 0.15);
            --shadow-color: rgba(0, 0, 0, 0.35);
        }

        /* Light Theme */
        [data-theme="light"] {
            --dark-blue: #f1f5f9;
            --medium-blue: #ffffff;
            --accent-primary: #2563eb;
            --accent-secondary: #7c3aed;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-tertiary: #64748b;
            --card-bg: rgba(255, 255, 255, 0.95);
            --background-color: #f1f5f9;
            --surface-color: #ffffff;
            --border-color: rgba(0, 0, 0, 0.08);
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        /* System Theme Detection */
        @media (prefers-color-scheme: light) {
            :root:not([data-theme]) {
                --dark-blue: #f1f5f9;
                --medium-blue: #ffffff;
                --accent-primary: #2563eb;
                --accent-secondary: #7c3aed;
                --text-primary: #1e293b;
                --text-secondary: #475569;
                --text-tertiary: #64748b;
                --card-bg: rgba(255, 255, 255, 0.95);
                --background-color: #f1f5f9;
                --surface-color: #ffffff;
                --border-color: rgba(0, 0, 0, 0.08);
                --shadow-color: rgba(0, 0, 0, 0.1);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        html {
            font-size: 15px;
            scroll-behavior: smooth;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.5;
            transition: background-color 0.3s ease, color 0.3s ease;
            font-weight: 400;
        }

        /* Professional Background Pattern */
        .background-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 15% 50%, rgba(37, 99, 235, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 85% 30%, rgba(124, 58, 237, 0.03) 0%, transparent 50%);
            z-index: -1;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 25, 47, 0.95);
            backdrop-filter: blur(10px);
            z-index: 10003;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid transparent;
            border-top-color: var(--accent-primary);
            border-right-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            color: var(--text-primary);
            font-size: 15px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Professional Top Navigation */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--topbar-height);
            background: var(--surface-color);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            z-index: 1000;
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-elevated);
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .back-btn {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .back-btn:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
            transform: translateX(-2px);
        }

        .brand-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-logo-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .brand-text {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 18px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--text-primary), var(--text-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }

        .brand-subtitle {
            font-size: 11px;
            color: var(--text-tertiary);
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        /* Notification Bell */
        .notification-bell {
            position: relative;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .notification-bell:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent-danger);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
            font-weight: 700;
            border: 2px solid var(--surface-color);
        }

        /* Notification Dropdown */
        .notification-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 350px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: var(--shadow-elevated);
            backdrop-filter: blur(20px);
            z-index: 1001;
            display: none;
            animation: slideDown 0.2s ease-out;
        }

        .notification-dropdown.active {
            display: block;
        }

        .notification-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-title {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .notification-clear {
            background: none;
            border: none;
            color: var(--accent-primary);
            font-size: 13px;
            cursor: pointer;
            transition: var(--transition);
        }

        .notification-clear:hover {
            color: var(--accent-secondary);
        }

        .notification-list {
            padding: 8px 0;
        }

        .notification-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
        }

        .notification-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .notification-item.unread {
            background: rgba(var(--accent-primary-rgb), 0.08);
        }

        .notification-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(var(--accent-primary-rgb), 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-primary);
            margin-right: 12px;
        }

        .notification-content {
            flex: 1;
        }

        .notification-message {
            font-size: 13px;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .notification-time {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .notification-empty {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-tertiary);
        }

        /* Professional Theme Toggle */
        .theme-toggle-wrapper {
            position: relative;
        }

        .theme-toggle {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .theme-toggle:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
            transform: rotate(15deg);
        }

        /* Theme Dropdown */
        .theme-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            min-width: 240px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: var(--shadow-elevated);
            backdrop-filter: blur(20px);
            z-index: 1001;
            display: none;
            animation: slideDown 0.2s ease-out;
        }

        .theme-dropdown.active {
            display: block;
        }

        .theme-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: var(--transition);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }

        .theme-option:hover {
            background: rgba(var(--accent-primary-rgb), 0.1);
            color: var(--text-primary);
        }

        .theme-option.active {
            color: var(--accent-primary);
            background: rgba(var(--accent-primary-rgb), 0.08);
        }

        .theme-preview {
            width: 20px;
            height: 20px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        /* User Profile */
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
        }

        .user-profile:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            color: white;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            overflow: hidden;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .user-role {
            font-size: 11px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Main Chat Container */
        .chat-container {
            margin-top: var(--topbar-height);
            min-height: calc(100vh - var(--topbar-height));
            display: flex;
            padding: 20px;
            gap: 20px;
            max-width: 1600px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Professional Chat Sidebar */
        .chat-sidebar {
            width: 320px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: calc(100vh - var(--topbar-height) - 40px);
            overflow: hidden;
            box-shadow: var(--shadow-elevated);
        }

        .chat-sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .chat-sidebar-title {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .chat-search {
            position: relative;
            margin-bottom: 20px;
        }

        .chat-search input {
            width: 100%;
            padding: 12px 16px 12px 40px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            transition: var(--transition);
        }

        .chat-search input:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: rgba(var(--accent-primary-rgb), 0.05);
            box-shadow: 0 0 0 3px rgba(var(--accent-primary-rgb), 0.1);
        }

        .chat-search i {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
            font-size: 14px;
        }

        /* Professional Tabs */
        .chat-tabs {
            display: flex;
            gap: 4px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 4px;
        }

        .chat-tab {
            flex: 1;
            padding: 10px 0;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: var(--transition);
        }

        .chat-tab:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .chat-tab.active {
            color: var(--accent-primary);
            background: var(--surface-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Conversations List */
        .conversations-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px 0;
        }

        .conversation-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 24px;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid var(--border-color);
        }

        .conversation-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .conversation-item.active {
            background: rgba(var(--accent-primary-rgb), 0.1);
            border-left: 4px solid var(--accent-primary);
        }

        .conversation-avatar {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 15px;
            color: white;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
        }

        .conversation-info {
            flex: 1;
            min-width: 0;
        }

        .conversation-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .conversation-preview {
            font-size: 12px;
            color: var(--text-tertiary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .conversation-time {
            font-size: 11px;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        .conversation-unread {
            background: var(--accent-primary);
            color: white;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 12px;
            min-width: 20px;
            text-align: center;
            font-weight: 700;
        }

        /* Professional New Chat Button */
        .new-chat-btn {
            margin: 20px 24px;
            padding: 14px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 20px rgba(var(--accent-primary-rgb), 0.3);
        }

        .new-chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(var(--accent-primary-rgb), 0.4);
        }

        /* Main Chat Area */
        .chat-main {
            flex: 1;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: calc(100vh - var(--topbar-height) - 40px);
            overflow: hidden;
            box-shadow: var(--shadow-elevated);
        }

        /* Professional Chat Header */
        .chat-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            background: var(--surface-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            display: none;
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .chat-header-avatar {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
            color: white;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
        }

        .chat-header-details h3 {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .chat-header-details p {
            font-size: 13px;
            color: var(--text-tertiary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--online-color);
        }

        .status-indicator.away {
            background: var(--away-color);
        }

        .status-indicator.offline {
            background: var(--offline-color);
        }

        .chat-header-actions {
            display: flex;
            gap: 8px;
        }

        /* Professional Messages Container */
        .messages-container {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: rgba(10, 25, 47, 0.5);
        }

        .message-date {
            text-align: center;
            margin: 16px 0;
        }

        .date-label {
            display: inline-block;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            font-size: 12px;
            color: var(--text-tertiary);
            font-weight: 500;
            border: 1px solid var(--border-color);
        }

        /* Professional Message Styling */
        .message {
            display: flex;
            max-width: 70%;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.sent {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.received {
            align-self: flex-start;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 13px;
            color: white;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            flex-shrink: 0;
            margin-top: 6px;
        }

        .message-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-width: 100%;
        }

        .message-bubble {
            padding: 14px 18px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            max-width: 100%;
            border: 1px solid transparent;
        }

        .message.sent .message-bubble {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border-bottom-right-radius: 8px;
            box-shadow: 0 2px 8px rgba(var(--accent-primary-rgb), 0.3);
        }

        .message.received .message-bubble {
            background: var(--surface-color);
            color: var(--text-primary);
            border-bottom-left-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .message-text {
            font-size: 14px;
            line-height: 1.5;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.8;
            align-self: flex-end;
            margin-top: 2px;
            font-weight: 500;
        }

        /* Professional File Attachments */
        .file-attachment {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-top: 8px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
        }

        .file-attachment:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--accent-primary);
            transform: translateY(-1px);
        }

        .file-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: rgba(var(--accent-primary-rgb), 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-primary);
            font-size: 18px;
        }

        .file-info {
            flex: 1;
            min-width: 0;
        }

        .file-name {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 2px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-size {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .file-download {
            color: var(--accent-primary);
            font-size: 16px;
            opacity: 0.7;
            transition: var(--transition);
        }

        .file-download:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        /* Professional Message Input */
        .message-input-container {
            padding: 20px 24px;
            border-top: 1px solid var(--border-color);
            background: var(--surface-color);
        }

        .message-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .input-action-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .input-action-btn:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
            transform: translateY(-1px);
        }

        .message-input {
            flex: 1;
            min-height: 48px;
            max-height: 120px;
            padding: 14px 18px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            color: var(--text-primary);
            font-size: 14px;
            resize: none;
            transition: var(--transition);
            line-height: 1.5;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: rgba(var(--accent-primary-rgb), 0.05);
            box-shadow: 0 0 0 3px rgba(var(--accent-primary-rgb), 0.1);
        }

        .send-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            flex-shrink: 0;
            box-shadow: 0 4px 15px rgba(var(--accent-primary-rgb), 0.3);
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(var(--accent-primary-rgb), 0.4);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Upload Preview */
        .upload-preview {
            margin-bottom: 16px;
            padding: 16px;
            background: var(--surface-color);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: slideUp 0.3s ease-out;
        }

        .upload-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .upload-name {
            font-size: 13px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .upload-progress {
            width: 120px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .upload-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .upload-cancel {
            color: var(--accent-danger);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: var(--transition);
        }

        .upload-cancel:hover {
            color: #ff5252;
            transform: scale(1.1);
        }

        /* Online Users Sidebar */
        .online-users {
            width: 280px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: calc(100vh - var(--topbar-height) - 40px);
            overflow: hidden;
            box-shadow: var(--shadow-elevated);
        }

        .online-users-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .online-users-title {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .online-users-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px 0;
        }

        .online-user-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 24px;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid var(--border-color);
        }

        .online-user-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .online-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: white;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            position: relative;
        }

        .online-indicator {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            background: var(--online-color);
            border-radius: 50%;
            border: 2px solid var(--card-bg);
        }

        .online-user-info {
            flex: 1;
        }

        .online-user-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
            color: var(--text-primary);
        }

        .online-user-role {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* Workspace Stats */
        .workspace-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            padding: 24px;
        }

        .workspace-stat-card {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            padding: 20px;
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .workspace-stat-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-elevated);
        }

        .workspace-stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: rgba(var(--accent-primary-rgb), 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--accent-primary);
            margin-bottom: 16px;
        }

        .workspace-stat-value {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .workspace-stat-label {
            font-size: 13px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Recent Files */
        .recent-files {
            padding: 24px;
        }

        .recent-files-title {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .files-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--surface-color);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
        }

        .file-item:hover {
            border-color: var(--accent-primary);
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .file-item-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            background: rgba(var(--accent-primary-rgb), 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-primary);
            font-size: 20px;
        }

        .file-item-info {
            flex: 1;
        }

        .file-item-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-item-meta {
            font-size: 12px;
            color: var(--text-tertiary);
            display: flex;
            gap: 8px;
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 80px;
            right: 24px;
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            z-index: 10001;
            display: none;
            align-items: center;
            gap: 6px;
            backdrop-filter: blur(10px);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .connection-status.online {
            background: rgba(16, 185, 129, 0.15);
            color: var(--online-color);
            border: 1px solid rgba(16, 185, 129, 0.25);
        }

        .connection-status.offline {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-danger);
            border: 1px solid rgba(239, 68, 68, 0.25);
        }

        /* Permission Modal */
        .permission-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 10002;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .permission-modal.active {
            display: flex;
        }

        .permission-content {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            padding: 32px;
            max-width: 500px;
            text-align: center;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-elevated);
        }

        .permission-icon {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            color: white;
            font-size: 32px;
        }

        .permission-title {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .permission-text {
            color: var(--text-secondary);
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .permission-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .permission-btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            min-width: 120px;
        }

        .permission-btn.allow {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
        }

        .permission-btn.allow:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(var(--accent-primary-rgb), 0.4);
        }

        .permission-btn.deny {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .permission-btn.deny:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .online-users {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .chat-container {
                flex-direction: column;
                padding: 12px;
                gap: 12px;
            }
            
            .chat-sidebar {
                width: 100%;
                height: 300px;
            }
            
            .chat-main {
                height: calc(100vh - var(--topbar-height) - 320px);
            }

            .notification-dropdown {
                width: 300px;
                right: -50px;
            }
        }

        @media (max-width: 576px) {
            .top-nav {
                padding: 0 16px;
            }
            
            .workspace-stats-grid {
                grid-template-columns: 1fr;
            }

            .notification-dropdown {
                width: 280px;
                right: -100px;
            }
        }
    </style>
</head>
<body>
    <div class="background-pattern"></div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner"></div>
        <div class="loading-text">Loading Workspace...</div>
    </div>

    <!-- Connection Status -->
    <div class="connection-status" id="connectionStatus">
        <i class="fas fa-circle"></i>
        <span>Online</span>
    </div>

    <!-- Permission Request Modal -->
    <div class="permission-modal" id="permissionModal">
        <div class="permission-content">
            <div class="permission-icon">
                <i class="fas fa-bell"></i>
            </div>
            <h3 class="permission-title">Enable Notifications</h3>
            <p class="permission-text">Get real-time notifications for new messages, file shares, and team updates. Never miss important conversations with your team.</p>
            <div class="permission-buttons">
                <button class="permission-btn allow" id="allowNotifications">Allow</button>
                <button class="permission-btn deny" id="denyNotifications">Not Now</button>
            </div>
        </div>
    </div>

    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="nav-left">
            <button class="back-btn" onclick="window.location.href='index.html'">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="brand-logo">
                <div class="brand-logo-icon">
                    <i class="fas fa-comments"></i>
                </div>
                <div>
                    <div class="brand-text">Jasiri Workspace</div>
                    <div class="brand-subtitle">Enterprise Collaboration</div>
                </div>
            </div>
        </div>
        
        <div class="nav-right">
            <!-- Notification Bell -->
            <div class="notification-wrapper" style="position: relative;">
                <button class="notification-bell" id="notificationBell">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                </button>
                <div class="notification-dropdown" id="notificationDropdown">
                    <div class="notification-header">
                        <h4 class="notification-title">Notifications</h4>
                        <button class="notification-clear" id="clearNotifications">Clear All</button>
                    </div>
                    <div class="notification-list" id="notificationList">
                        <!-- Notifications will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Theme Toggle -->
            <div class="theme-toggle-wrapper" style="position: relative;">
                <button class="theme-toggle" id="themeToggle">
                    <i class="fas fa-palette"></i>
                </button>
                <div class="theme-dropdown" id="themeDropdown">
                    <div class="theme-option" data-theme="system">
                        <div class="theme-preview"></div>
                        <i class="fas fa-desktop"></i>
                        <span>System Default</span>
                    </div>
                    <div class="theme-option" data-theme="light">
                        <div class="theme-preview"></div>
                        <i class="fas fa-sun"></i>
                        <span>Light Theme</span>
                    </div>
                    <div class="theme-option" data-theme="corporate-blue">
                        <div class="theme-preview"></div>
                        <i class="fas fa-building"></i>
                        <span>Corporate Blue</span>
                    </div>
                    <div class="theme-option" data-theme="executive-dark">
                        <div class="theme-preview"></div>
                        <i class="fas fa-moon"></i>
                        <span>Executive Dark</span>
                    </div>
                </div>
            </div>
            
            <div class="user-profile" id="userProfile">
                <div class="user-avatar" id="userAvatar">AD</div>
                <div class="user-info">
                    <div class="user-name" id="userName">Administrator</div>
                    <div class="user-role" id="userRole">SYSTEM ADMIN</div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Workspace Container -->
    <div class="chat-container">
        <!-- Left Sidebar - Conversations -->
        <div class="chat-sidebar">
            <div class="chat-sidebar-header">
                <h3 class="chat-sidebar-title">Conversations</h3>
                <div class="chat-search">
                    <i class="fas fa-search"></i>
                    <input type="text" id="chatSearch" placeholder="Search conversations...">
                </div>
                <div class="chat-tabs">
                    <button class="chat-tab active" data-tab="all">All</button>
                    <button class="chat-tab" data-tab="unread">Unread</button>
                    <button class="chat-tab" data-tab="groups">Teams</button>
                </div>
            </div>

            <div class="conversations-list" id="conversationsList">
                <!-- Conversations will be loaded here -->
            </div>

            <button class="new-chat-btn" id="newChatBtn">
                <i class="fas fa-plus"></i>
                <span>New Conversation</span>
            </button>
        </div>

        <!-- Main Chat Area -->
        <div class="chat-main">
            <!-- Welcome View -->
            <div class="messages-container" id="messagesContainer">
                <div class="no-chat-selected">
                    <div style="text-align: center; padding: 40px;">
                        <div style="width: 80px; height: 80px; border-radius: 20px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); display: flex; align-items: center; justify-content: center; margin: 0 auto 24px;">
                            <i class="fas fa-comments" style="font-size: 32px; color: white;"></i>
                        </div>
                        <h3 style="font-family: 'Plus Jakarta Sans', sans-serif; font-size: 24px; font-weight: 700; margin-bottom: 12px; color: var(--text-primary);">Enterprise Workspace</h3>
                        <p style="color: var(--text-tertiary); max-width: 500px; margin: 0 auto 32px;">Select a conversation to start collaborating with your team members.</p>
                        
                        <!-- Workspace Stats -->
                        <div class="workspace-stats-grid">
                            <div class="workspace-stat-card">
                                <div class="workspace-stat-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="workspace-stat-value" id="welcomeOnlineCount">0</div>
                                <div class="workspace-stat-label">Team Online</div>
                            </div>
                            <div class="workspace-stat-card">
                                <div class="workspace-stat-icon">
                                    <i class="fas fa-comment"></i>
                                </div>
                                <div class="workspace-stat-value" id="welcomeMessageCount">0</div>
                                <div class="workspace-stat-label">Total Messages</div>
                            </div>
                            <div class="workspace-stat-card">
                                <div class="workspace-stat-icon">
                                    <i class="fas fa-file"></i>
                                </div>
                                <div class="workspace-stat-value" id="welcomeFileCount">0</div>
                                <div class="workspace-stat-label">Files Shared</div>
                            </div>
                            <div class="workspace-stat-card">
                                <div class="workspace-stat-icon">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="workspace-stat-value" id="welcomeActiveCount">0</div>
                                <div class="workspace-stat-label">Active Chats</div>
                            </div>
                        </div>

                        <!-- Recent Files -->
                        <div class="recent-files">
                            <h4 class="recent-files-title">Recent Files</h4>
                            <div class="files-list" id="recentFilesList">
                                <!-- Recent files will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Header (Hidden by default) -->
            <div class="chat-header" id="chatHeader">
                <div class="chat-header-info">
                    <div class="chat-header-avatar" id="chatHeaderAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="chat-header-details">
                        <h3 id="chatPartnerName">Select a conversation</h3>
                        <p id="chatStatus">
                            <span class="status-indicator offline" id="statusIndicator"></span>
                            <span id="statusText">Select a conversation to start chatting</span>
                        </p>
                    </div>
                </div>
                <div class="chat-header-actions">
                    <button class="input-action-btn" id="videoCallBtn" title="Video Call">
                        <i class="fas fa-video"></i>
                    </button>
                    <button class="input-action-btn" id="audioCallBtn" title="Audio Call">
                        <i class="fas fa-phone"></i>
                    </button>
                    <button class="input-action-btn" id="chatInfoBtn" title="Chat Info">
                        <i class="fas fa-info-circle"></i>
                    </button>
                </div>
            </div>

            <!-- Message Input (Hidden by default) -->
            <div class="message-input-container" id="messageInputContainer">
                <div class="upload-preview" id="uploadPreview" style="display: none;">
                    <div class="upload-info">
                        <div class="upload-name" id="uploadFileName">file.pdf</div>
                        <div class="upload-progress">
                            <div class="upload-progress-fill" id="uploadProgressFill" style="width: 0%"></div>
                        </div>
                    </div>
                    <button class="upload-cancel" id="cancelUploadBtn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="input-actions">
                    <button class="input-action-btn" id="attachFileBtn" title="Attach File">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <button class="input-action-btn" id="attachImageBtn" title="Attach Image">
                        <i class="fas fa-image"></i>
                    </button>
                    <button class="input-action-btn" id="emojiBtn" title="Insert Emoji">
                        <i class="fas fa-smile"></i>
                    </button>
                </div>
                <div class="message-input-wrapper">
                    <textarea class="message-input" id="messageInput" placeholder="Type your message..." rows="1"></textarea>
                    <button class="send-btn" id="sendBtn" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Right Sidebar - Online Users -->
        <div class="online-users">
            <div class="online-users-header">
                <h3 class="online-users-title">
                    <i class="fas fa-users"></i> Online Team
                </h3>
            </div>
            <div class="online-users-list" id="onlineUsersList">
                <!-- Online users will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>

    <script>
        // ============================
        // HARDCODED USER IDENTITIES
        // ============================
        const HARDCODED_USERS = {
            'office.hog@gmail.com': {
                name: 'Central Admin',
                photo: 'https://i.postimg.cc/3wvN3Xqc/COLLECTIONS.png',
                role: 'Administrator',
                department: 'HOG-NBI001'
            },
            'sales.hog@gmail.com': {
                name: 'Sales Clerk',
                photo: 'https://i.postimg.cc/3wvN3Xqc/COLLECTIONS.png',
                role: 'Sales',
                department: 'Sales and Marketing'
            },
            'manager@hogcreations.com': {
                name: 'Operations Manager',
                photo: 'https://i.postimg.cc/9XbqzBx4/HOG-creations.png',
                role: 'Manager',
                department: 'Operations'
            },
            'sales@hogcreations.com': {
                name: 'Sales Director',
                photo: 'https://i.postimg.cc/9XbqzBx4/HOG-creations.png',
                role: 'Director',
                department: 'Sales'
            },
            'finance@hogcreations.com': {
                name: 'Finance Manager',
                photo: 'https://i.postimg.cc/9XbqzBx4/HOG-creations.png',
                role: 'Manager',
                department: 'Finance'
            },
            'hr@hogcreations.com': {
                name: 'HR Manager',
                photo: 'https://i.postimg.cc/9XbqzBx4/HOG-creations.png',
                role: 'Manager',
                department: 'Human Resources'
            },
            'logistics@hogcreations.com': {
                name: 'Logistics Head',
                photo: 'https://i.postimg.cc/9XbqzBx4/HOG-creations.png',
                role: 'Manager',
                department: 'Logistics'
            }
        };

        // ============================
        // FIREBASE CONFIGURATION
        // ============================
        const firebaseConfig = {
            apiKey: "AIzaSyCOb4BqfiN3vt1Y13UTEpA_boCqNRH6rrQ",
            authDomain: "dsog-stores-dashboard.firebaseapp.com",
            databaseURL: "https://dsog-stores-dashboard-default-rtdb.firebaseio.com",
            projectId: "dsog-stores-dashboard",
            storageBucket: "dsog-stores-dashboard.firebasestorage.app",
            messagingSenderId: "1085972125142",
            appId: "1:1085972125142:web:9abea9ee0dd792a052c077"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();
        const messaging = firebase.messaging();

        // ============================
        // APPLICATION VARIABLES
        // ============================
        let currentUserId = null;
        let currentUserEmail = null;
        let currentUserInfo = null;
        let currentChatId = null;
        let currentChatType = null;
        let isOnline = navigator.onLine;
        let conversationsListener = null;
        let messagesListener = null;
        let onlineUsersListener = null;
        let notificationsListener = null;
        let uploadTask = null;
        let notificationCount = 0;
        let notificationSound = null;
        let fcmToken = null;

        // ============================
        // UTILITY FUNCTIONS
        // ============================
        function getUserInfo(email) {
            const normalizedEmail = email.toLowerCase().trim();
            return HARDCODED_USERS[normalizedEmail] || {
                name: email.split('@')[0],
                photo: null,
                role: 'User',
                department: 'General'
            };
        }

        function getInitials(name) {
            if (!name) return '??';
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }

        function formatFileSize(bytes) {
            if (!bytes) return '';
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function generateChatId(user1Id, user2Id) {
            return [user1Id, user2Id].sort().join('_');
        }

        // ============================
        // NOTIFICATION SYSTEM
        // ============================
        async function requestNotificationPermission() {
            try {
                // Check if browser supports notifications
                if (!('Notification' in window)) {
                    console.log('This browser does not support notifications');
                    return false;
                }

                // Check current permission
                if (Notification.permission === 'granted') {
                    await setupFCM();
                    return true;
                } else if (Notification.permission === 'denied') {
                    console.log('Notification permission denied');
                    return false;
                } else {
                    // Show custom permission modal
                    document.getElementById('permissionModal').classList.add('active');
                    
                    return new Promise((resolve) => {
                        document.getElementById('allowNotifications').onclick = async () => {
                            document.getElementById('permissionModal').classList.remove('active');
                            const permission = await Notification.requestPermission();
                            if (permission === 'granted') {
                                await setupFCM();
                                resolve(true);
                            } else {
                                resolve(false);
                            }
                        };
                        
                        document.getElementById('denyNotifications').onclick = () => {
                            document.getElementById('permissionModal').classList.remove('active');
                            resolve(false);
                        };
                    });
                }
            } catch (error) {
                console.error('Error requesting notification permission:', error);
                return false;
            }
        }

        async function setupFCM() {
            try {
                // Request permission and get token
                fcmToken = await messaging.getToken({ 
                    vapidKey: 'BElzXoP_6QnG_wy3YhQn6j7q3v9K8LmM5tJkLpO9sQq4rT7vXwYzAaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPp' // You need to generate this in Firebase Console
                });
                
                if (fcmToken) {
                    // Save token to user's database record
                    await database.ref(`users/${currentUserId}/fcmToken`).set(fcmToken);
                    console.log('FCM Token saved:', fcmToken);
                    
                    // Setup message handler for background notifications
                    messaging.onMessage((payload) => {
                        console.log('Message received:', payload);
                        showNotification(payload.notification.title, payload.notification.body);
                    });
                    
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Error setting up FCM:', error);
                return false;
            }
        }

        function showNotification(title, body, tag = 'new-message') {
            // Create notification sound
            if (!notificationSound) {
                notificationSound = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ');
            }

            // Play notification sound
            try {
                notificationSound.play();
            } catch (error) {
                console.log('Could not play notification sound:', error);
            }

            // Check if browser supports notifications
            if (!('Notification' in window) || Notification.permission !== 'granted') {
                // Fallback to in-app notification
                addInAppNotification(title, body, 'message');
                return;
            }

            // Create and show notification
            const notification = new Notification(title, {
                body: body,
                icon: '/favicon.ico',
                tag: tag,
                requireInteraction: false,
                silent: false // This will use the default notification sound
            });

            // Handle notification click
            notification.onclick = () => {
                window.focus();
                notification.close();
                // You could add logic to navigate to the specific chat
            };

            // Also add to in-app notifications
            addInAppNotification(title, body, 'message');
        }

        function addInAppNotification(title, message, type = 'message') {
            try {
                const notificationList = document.getElementById('notificationList');
                const notificationBadge = document.getElementById('notificationBadge');
                
                // Create notification item
                const notificationItem = document.createElement('div');
                notificationItem.className = 'notification-item unread';
                notificationItem.dataset.id = Date.now();
                
                const icon = type === 'message' ? 'fa-comment' : 
                            type === 'file' ? 'fa-file' : 
                            type === 'user' ? 'fa-user-plus' : 'fa-bell';
                
                notificationItem.innerHTML = `
                    <div style="display: flex; align-items: flex-start;">
                        <div class="notification-icon">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div class="notification-content">
                            <div class="notification-message">
                                <strong>${title}</strong><br>
                                ${message}
                            </div>
                            <div class="notification-time">Just now</div>
                        </div>
                    </div>
                `;
                
                // Add click handler
                notificationItem.addEventListener('click', () => {
                    notificationItem.classList.remove('unread');
                    updateNotificationBadge(-1);
                });
                
                // Add to top of list
                notificationList.insertBefore(notificationItem, notificationList.firstChild);
                
                // Update badge
                updateNotificationBadge(1);
                
                // Keep only last 50 notifications
                const items = notificationList.querySelectorAll('.notification-item');
                if (items.length > 50) {
                    items[items.length - 1].remove();
                }
                
                // Save to database
                saveNotificationToDB(title, message, type);
                
            } catch (error) {
                console.error('Error adding in-app notification:', error);
            }
        }

        async function saveNotificationToDB(title, message, type) {
            try {
                const notificationId = Date.now();
                await database.ref(`notifications/${currentUserId}/${notificationId}`).set({
                    title: title,
                    message: message,
                    type: type,
                    timestamp: Date.now(),
                    read: false
                });
            } catch (error) {
                console.error('Error saving notification to DB:', error);
            }
        }

        function updateNotificationBadge(change) {
            notificationCount = Math.max(0, notificationCount + change);
            const badge = document.getElementById('notificationBadge');
            
            if (notificationCount > 0) {
                badge.textContent = notificationCount > 99 ? '99+' : notificationCount;
                badge.style.display = 'block';
                
                // Add animation
                badge.style.animation = 'none';
                setTimeout(() => {
                    badge.style.animation = 'pulse 0.5s ease-in-out';
                }, 10);
            } else {
                badge.style.display = 'none';
            }
        }

        async function loadNotifications() {
            try {
                const snapshot = await database.ref(`notifications/${currentUserId}`).orderByChild('timestamp').limitToLast(50).once('value');
                const notifications = snapshot.val();
                const notificationList = document.getElementById('notificationList');
                
                if (!notifications) {
                    notificationList.innerHTML = `
                        <div class="notification-empty">
                            <i class="fas fa-bell-slash" style="font-size: 32px; margin-bottom: 12px; opacity: 0.5;"></i>
                            <p>No notifications yet</p>
                        </div>
                    `;
                    return;
                }
                
                // Convert to array and sort by timestamp
                const notificationsArray = Object.entries(notifications)
                    .map(([id, data]) => ({ id, ...data }))
                    .sort((a, b) => b.timestamp - a.timestamp);
                
                notificationList.innerHTML = '';
                let unreadCount = 0;
                
                notificationsArray.forEach(notification => {
                    const notificationItem = document.createElement('div');
                    notificationItem.className = `notification-item ${notification.read ? '' : 'unread'}`;
                    notificationItem.dataset.id = notification.id;
                    
                    const icon = notification.type === 'message' ? 'fa-comment' : 
                                notification.type === 'file' ? 'fa-file' : 
                                notification.type === 'user' ? 'fa-user-plus' : 'fa-bell';
                    
                    notificationItem.innerHTML = `
                        <div style="display: flex; align-items: flex-start;">
                            <div class="notification-icon">
                                <i class="fas ${icon}"></i>
                            </div>
                            <div class="notification-content">
                                <div class="notification-message">
                                    <strong>${notification.title}</strong><br>
                                    ${notification.message}
                                </div>
                                <div class="notification-time">${formatTime(notification.timestamp)}</div>
                            </div>
                        </div>
                    `;
                    
                    // Add click handler
                    notificationItem.addEventListener('click', () => {
                        markNotificationAsRead(notification.id);
                        notificationItem.classList.remove('unread');
                        updateNotificationBadge(-1);
                    });
                    
                    notificationList.appendChild(notificationItem);
                    
                    if (!notification.read) {
                        unreadCount++;
                    }
                });
                
                updateNotificationBadge(unreadCount - notificationCount);
                
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        async function markNotificationAsRead(notificationId) {
            try {
                await database.ref(`notifications/${currentUserId}/${notificationId}/read`).set(true);
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        async function clearAllNotifications() {
            try {
                await database.ref(`notifications/${currentUserId}`).remove();
                document.getElementById('notificationList').innerHTML = `
                    <div class="notification-empty">
                        <i class="fas fa-bell-slash" style="font-size: 32px; margin-bottom: 12px; opacity: 0.5;"></i>
                        <p>No notifications yet</p>
                    </div>
                `;
                updateNotificationBadge(-notificationCount);
            } catch (error) {
                console.error('Error clearing notifications:', error);
            }
        }

        // ============================
        // FILE UPLOAD - FIXED VERSION
        // ============================
        async function uploadFile(file, isImage = false) {
            if (!file || !currentChatId) return null;
            
            try {
                // Show upload preview
                document.getElementById('uploadFileName').textContent = file.name;
                document.getElementById('uploadProgressFill').style.width = '0%';
                document.getElementById('uploadPreview').style.display = 'flex';
                
                // Create unique file name
                const timestamp = Date.now();
                const randomString = Math.random().toString(36).substring(2, 15);
                const fileExtension = file.name.split('.').pop();
                const fileName = `${timestamp}_${randomString}.${fileExtension}`;
                const filePath = `chat_files/${currentChatId}/${fileName}`;
                
                console.log('Starting upload:', file.name, 'Size:', file.size, 'Type:', file.type);
                
                // Create storage reference
                const storageRef = storage.ref(filePath);
                
                // Create upload task with metadata
                uploadTask = storageRef.put(file, {
                    customMetadata: {
                        originalName: file.name,
                        uploadedBy: currentUserEmail,
                        chatId: currentChatId,
                        timestamp: timestamp.toString()
                    }
                });
                
                return new Promise((resolve, reject) => {
                    uploadTask.on('state_changed',
                        (snapshot) => {
                            // Update progress
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            console.log('Upload progress:', progress + '%');
                            document.getElementById('uploadProgressFill').style.width = progress + '%';
                            
                            // Show more detailed progress for debugging
                            if (snapshot.bytesTransferred === snapshot.totalBytes) {
                                console.log('Upload complete, getting download URL...');
                            }
                        },
                        (error) => {
                            console.error('Upload error details:', error);
                            console.error('Error code:', error.code);
                            console.error('Error message:', error.message);
                            
                            // Hide upload preview
                            document.getElementById('uploadPreview').style.display = 'none';
                            
                            // Show user-friendly error
                            let errorMessage = 'Upload failed. ';
                            
                            switch (error.code) {
                                case 'storage/unauthorized':
                                    errorMessage += 'You don\'t have permission to upload files.';
                                    break;
                                case 'storage/canceled':
                                    errorMessage += 'Upload was cancelled.';
                                    break;
                                case 'storage/unknown':
                                    errorMessage += 'Unknown error occurred. Please check your internet connection.';
                                    break;
                                default:
                                    errorMessage += 'Please try again.';
                            }
                            
                            alert(errorMessage);
                            reject(error);
                        },
                        async () => {
                            try {
                                console.log('Upload completed successfully');
                                
                                // Get download URL
                                const downloadURL = await storageRef.getDownloadURL();
                                console.log('Download URL obtained:', downloadURL);
                                
                                // Get file metadata
                                const metadata = await storageRef.getMetadata();
                                console.log('File metadata:', metadata);
                                
                                // Hide upload preview
                                document.getElementById('uploadPreview').style.display = 'none';
                                
                                resolve({
                                    url: downloadURL,
                                    name: file.name,
                                    size: file.size,
                                    type: file.type,
                                    isImage: isImage
                                });
                                
                            } catch (urlError) {
                                console.error('Error getting download URL:', urlError);
                                document.getElementById('uploadPreview').style.display = 'none';
                                alert('File uploaded but could not get download link. Please try again.');
                                reject(urlError);
                            }
                        }
                    );
                });
            } catch (error) {
                console.error('Upload initialization error:', error);
                document.getElementById('uploadPreview').style.display = 'none';
                alert('Failed to start upload. Please try again.');
                return null;
            }
        }

        function cancelUpload() {
            if (uploadTask) {
                uploadTask.cancel();
                console.log('Upload cancelled by user');
                document.getElementById('uploadPreview').style.display = 'none';
            }
        }

        // ============================
        // MESSAGE SENDING
        // ============================
        async function sendMessage(text, fileData = null) {
            if (!currentChatId || (!text.trim() && !fileData)) return;
            
            try {
                let messageData = {
                    senderId: currentUserId,
                    senderInfo: currentUserInfo,
                    text: text.trim(),
                    timestamp: Date.now(),
                    read: false
                };
                
                if (fileData) {
                    messageData.type = fileData.isImage ? 'image' : 'file';
                    messageData.fileUrl = fileData.url;
                    messageData.fileName = fileData.name;
                    messageData.fileSize = fileData.size;
                    messageData.fileType = fileData.type;
                    
                    if (fileData.isImage) {
                        messageData.imageUrl = fileData.url;
                    }
                } else {
                    messageData.type = 'text';
                }
                
                console.log('Sending message:', messageData);
                
                // Add message to database
                const messageRef = database.ref(`messages/${currentChatId}`).push();
                await messageRef.set(messageData);
                
                // Update conversation last message
                await database.ref(`conversations/${currentChatId}`).update({
                    lastMessage: {
                        text: messageData.text || (messageData.type === 'file' ? 'Shared a file' : 'Shared an image'),
                        timestamp: messageData.timestamp,
                        senderId: currentUserId
                    },
                    updatedAt: Date.now()
                });
                
                // Update unread counts for other participants
                const conversationSnapshot = await database.ref(`conversations/${currentChatId}/participants`).once('value');
                const participants = conversationSnapshot.val();
                
                if (participants) {
                    Object.keys(participants).forEach(async (participantId) => {
                        if (participantId !== currentUserId) {
                            const unreadRef = database.ref(`conversations/${currentChatId}/unreadCount/${participantId}`);
                            const currentUnread = await unreadRef.once('value');
                            await unreadRef.set((currentUnread.val() || 0) + 1);
                            
                            // Send notification to other participants
                            const participantEmail = participants[participantId].email;
                            const participantInfo = getUserInfo(participantEmail);
                            
                            // Create notification message
                            const notificationTitle = `New message from ${currentUserInfo.name}`;
                            const notificationMessage = messageData.text || 
                                (messageData.type === 'file' ? 'Shared a file' : 'Shared an image');
                            
                            // Send push notification if participant has FCM token
                            const participantTokenSnapshot = await database.ref(`users/${participantId}/fcmToken`).once('value');
                            const participantToken = participantTokenSnapshot.val();
                            
                            if (participantToken) {
                                // In a real app, you would send this via your backend
                                // For now, we'll just log it
                                console.log('Would send push notification to:', participantEmail);
                            }
                            
                            // Add in-app notification for participant
                            await database.ref(`notifications/${participantId}/${Date.now()}`).set({
                                title: notificationTitle,
                                message: notificationMessage,
                                type: 'message',
                                timestamp: Date.now(),
                                read: false,
                                chatId: currentChatId
                            });
                        }
                    });
                }
                
                // Clear input and hide upload preview
                document.getElementById('messageInput').value = '';
                document.getElementById('sendBtn').disabled = true;
                document.getElementById('uploadPreview').style.display = 'none';
                
                // Update stats
                loadWorkspaceStats();
                loadRecentFiles();
                
                console.log('Message sent successfully');
                
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message. Please try again.');
            }
        }

        // ============================
        // INITIALIZATION
        // ============================
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('Initializing application...');
                
                // Show loading
                document.getElementById('loadingSpinner').style.display = 'flex';
                
                // Check authentication
                auth.onAuthStateChanged(async (user) => {
                    if (!user) {
                        console.log('No user found, redirecting to login...');
                        window.location.href = 'index.html';
                        return;
                    }
                    
                    console.log('User authenticated:', user.email);
                    
                    currentUserId = user.uid;
                    currentUserEmail = user.email;
                    currentUserInfo = getUserInfo(user.email);
                    
                    // Update user info
                    document.getElementById('userAvatar').textContent = getInitials(currentUserInfo.name);
                    document.getElementById('userName').textContent = currentUserInfo.name;
                    document.getElementById('userRole').textContent = currentUserInfo.role.toUpperCase();
                    
                    // Set online status
                    await database.ref(`userStatus/${currentUserId}`).set({
                        status: 'online',
                        lastSeen: Date.now(),
                        name: currentUserInfo.name,
                        email: currentUserEmail,
                        role: currentUserInfo.role
                    });
                    
                    // Request notification permission
                    await requestNotificationPermission();
                    
                    // Load notifications
                    await loadNotifications();
                    
                    // Load conversations
                    loadConversations();
                    
                    // Load online users
                    loadOnlineUsers();
                    
                    // Load workspace stats
                    loadWorkspaceStats();
                    
                    // Set up event listeners
                    setupEventListeners();
                    
                    // Set up real-time listeners for notifications
                    setupNotificationListeners();
                    
                    // Hide loading
                    document.getElementById('loadingSpinner').style.display = 'none';
                    
                    console.log('Application initialized successfully');
                });
            } catch (error) {
                console.error('Initialization error:', error);
                alert('Failed to initialize application. Please refresh the page.');
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        });

        // ============================
        // NOTIFICATION LISTENERS
        // ============================
        function setupNotificationListeners() {
            // Listen for new messages in conversations where user is a participant
            database.ref('conversations').orderByChild('updatedAt').on('child_changed', async (snapshot) => {
                try {
                    const conversation = snapshot.val();
                    const conversationId = snapshot.key;
                    
                    // Check if user is a participant
                    if (conversation.participants && conversation.participants[currentUserId]) {
                        // Check if this is a new message (not from current user)
                        if (conversation.lastMessage && conversation.lastMessage.senderId !== currentUserId) {
                            // Don't show notification if user is currently viewing this chat
                            if (conversationId === currentChatId) return;
                            
                            // Get sender info
                            const senderInfo = conversation.participants[conversation.lastMessage.senderId];
                            const senderName = senderInfo ? senderInfo.name : 'Someone';
                            
                            // Create notification
                            const notificationTitle = `New message from ${senderName}`;
                            const notificationMessage = conversation.lastMessage.text || 'Sent a message';
                            
                            // Show notification
                            showNotification(notificationTitle, notificationMessage);
                            
                            // Update unread count in sidebar
                            updateConversationUnreadCount(conversationId);
                        }
                    }
                } catch (error) {
                    console.error('Error in conversation listener:', error);
                }
            });
            
            // Listen for new notifications in database
            database.ref(`notifications/${currentUserId}`).orderByChild('timestamp').limitToLast(1).on('child_added', (snapshot) => {
                try {
                    const notification = snapshot.val();
                    
                    // Don't show notification if it's from current user's own actions
                    if (!notification.read && notification.type !== 'system') {
                        showNotification(notification.title, notification.message, notification.type);
                    }
                } catch (error) {
                    console.error('Error in notification listener:', error);
                }
            });
        }

        function updateConversationUnreadCount(conversationId) {
            const conversationItem = document.querySelector(`.conversation-item[data-chat-id="${conversationId}"]`);
            if (conversationItem) {
                let unreadElement = conversationItem.querySelector('.conversation-unread');
                if (!unreadElement) {
                    unreadElement = document.createElement('div');
                    unreadElement.className = 'conversation-unread';
                    conversationItem.querySelector('.conversation-meta').appendChild(unreadElement);
                }
                
                const currentCount = parseInt(unreadElement.textContent) || 0;
                unreadElement.textContent = currentCount + 1;
            }
        }

        // ============================
        // EVENT LISTENERS
        // ============================
        function setupEventListeners() {
            // Message input
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            
            messageInput.addEventListener('input', () => {
                sendBtn.disabled = !messageInput.value.trim();
                autoResizeTextarea();
            });
            
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (messageInput.value.trim()) {
                        sendMessage(messageInput.value);
                    }
                }
            });
            
            sendBtn.addEventListener('click', () => {
                if (messageInput.value.trim()) {
                    sendMessage(messageInput.value);
                }
            });
            
            // File attachments - FIXED
            document.getElementById('attachFileBtn').addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '*/*';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        console.log('File selected:', file.name, 'Size:', file.size);
                        
                        // Check file size (limit to 50MB)
                        const maxSize = 50 * 1024 * 1024; // 50MB in bytes
                        if (file.size > maxSize) {
                            alert('File size exceeds 50MB limit. Please choose a smaller file.');
                            return;
                        }
                        
                        try {
                            const fileData = await uploadFile(file, false);
                            if (fileData) {
                                await sendMessage('', fileData);
                            }
                        } catch (error) {
                            console.error('File upload failed:', error);
                        }
                    }
                };
                input.click();
            });
            
            document.getElementById('attachImageBtn').addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        console.log('Image selected:', file.name, 'Size:', file.size);
                        
                        // Check file size (limit to 20MB for images)
                        const maxSize = 20 * 1024 * 1024; // 20MB in bytes
                        if (file.size > maxSize) {
                            alert('Image size exceeds 20MB limit. Please choose a smaller image.');
                            return;
                        }
                        
                        try {
                            const fileData = await uploadFile(file, true);
                            if (fileData) {
                                await sendMessage('', fileData);
                            }
                        } catch (error) {
                            console.error('Image upload failed:', error);
                        }
                    }
                };
                input.click();
            });
            
            // Cancel upload
            document.getElementById('cancelUploadBtn').addEventListener('click', cancelUpload);
            
            // Notification bell
            document.getElementById('notificationBell').addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('notificationDropdown').classList.toggle('active');
            });
            
            // Clear notifications
            document.getElementById('clearNotifications').addEventListener('click', clearAllNotifications);
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.notification-wrapper')) {
                    document.getElementById('notificationDropdown').classList.remove('active');
                }
                if (!e.target.closest('.theme-toggle-wrapper')) {
                    document.getElementById('themeDropdown').classList.remove('active');
                }
            });
            
            // New chat button
            document.getElementById('newChatBtn').addEventListener('click', () => {
                alert('New chat functionality coming soon!');
            });
            
            // Chat tabs
            document.querySelectorAll('.chat-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.chat-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                });
            });
            
            // Search
            document.getElementById('chatSearch').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('.conversation-item').forEach(item => {
                    const name = item.querySelector('.conversation-name').textContent.toLowerCase();
                    item.style.display = name.includes(searchTerm) ? 'flex' : 'none';
                });
            });
            
            // Online user click
            document.getElementById('onlineUsersList').addEventListener('click', (e) => {
                const userItem = e.target.closest('.online-user-item');
                if (userItem) {
                    alert('Starting conversation with ' + userItem.querySelector('.online-user-name').textContent);
                }
            });
            
            // Network status
            window.addEventListener('online', () => {
                document.getElementById('connectionStatus').innerHTML = '<i class="fas fa-circle"></i><span>Online</span>';
                document.getElementById('connectionStatus').className = 'connection-status online';
                document.getElementById('connectionStatus').style.display = 'flex';
                setTimeout(() => {
                    document.getElementById('connectionStatus').style.display = 'none';
                }, 3000);
                
                // Update online status in database
                if (currentUserId) {
                    database.ref(`userStatus/${currentUserId}/status`).set('online');
                }
            });
            
            window.addEventListener('offline', () => {
                document.getElementById('connectionStatus').innerHTML = '<i class="fas fa-circle"></i><span>Offline</span>';
                document.getElementById('connectionStatus').className = 'connection-status offline';
                document.getElementById('connectionStatus').style.display = 'flex';
                
                // Update online status in database
                if (currentUserId) {
                    database.ref(`userStatus/${currentUserId}/status`).set('offline');
                }
            });
            
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('themeDropdown').classList.toggle('active');
            });
            
            // Theme options
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    e.preventDefault();
                    const theme = option.getAttribute('data-theme');
                    document.documentElement.setAttribute('data-theme', theme);
                    localStorage.setItem('theme', theme);
                    document.getElementById('themeDropdown').classList.remove('active');
                });
            });
            
            // Load saved theme
            const savedTheme = localStorage.getItem('theme') || 'system';
            document.documentElement.setAttribute('data-theme', savedTheme);
        }

        function autoResizeTextarea() {
            const textarea = document.getElementById('messageInput');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // ============================
        // DATA LOADING FUNCTIONS
        // ============================
        function loadConversations() {
            database.ref('conversations').orderByChild('updatedAt').limitToLast(50).on('value', (snapshot) => {
                const conversations = snapshot.val();
                const container = document.getElementById('conversationsList');
                container.innerHTML = '';
                
                if (!conversations) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-tertiary);">
                            <i class="fas fa-comments" style="font-size: 32px; margin-bottom: 16px; opacity: 0.5;"></i>
                            <p>No conversations yet</p>
                        </div>
                    `;
                    return;
                }
                
                Object.entries(conversations).forEach(([id, data]) => {
                    if (data.participants && data.participants[currentUserId]) {
                        const item = createConversationItem(id, data);
                        container.appendChild(item);
                    }
                });
            });
        }

        function createConversationItem(id, data) {
            const div = document.createElement('div');
            div.className = 'conversation-item';
            div.dataset.chatId = id;
            
            let name = data.name || 'Unknown';
            let avatarText = getInitials(name);
            let lastMessage = data.lastMessage?.text || 'No messages yet';
            
            if (data.type === 'direct') {
                const otherParticipant = Object.values(data.participants).find(p => p.email !== currentUserEmail);
                if (otherParticipant) {
                    name = otherParticipant.name;
                    avatarText = getInitials(name);
                }
            }
            
            const unreadCount = data.unreadCount?.[currentUserId] || 0;
            
            div.innerHTML = `
                <div class="conversation-avatar">${avatarText}</div>
                <div class="conversation-info">
                    <div class="conversation-name">${name}</div>
                    <div class="conversation-preview">${lastMessage}</div>
                </div>
                <div class="conversation-meta">
                    <div class="conversation-time">${formatTime(data.lastMessage?.timestamp)}</div>
                    ${unreadCount > 0 ? `<div class="conversation-unread">${unreadCount}</div>` : ''}
                </div>
            `;
            
            div.addEventListener('click', () => openChat(id, data));
            return div;
        }

        function openChat(id, data) {
            currentChatId = id;
            currentChatType = data.type;
            
            // Update UI
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.chatId === id) item.classList.add('active');
            });
            
            document.getElementById('chatHeader').style.display = 'flex';
            document.getElementById('messageInputContainer').style.display = 'block';
            document.getElementById('messagesContainer').innerHTML = '';
            document.getElementById('messagesContainer').style.display = 'flex';
            
            // Load chat info
            let chatName = data.name || 'Unknown';
            let avatarText = getInitials(chatName);
            
            if (data.type === 'direct') {
                const otherParticipant = Object.values(data.participants).find(p => p.email !== currentUserEmail);
                if (otherParticipant) {
                    chatName = otherParticipant.name;
                    avatarText = getInitials(chatName);
                }
            }
            
            document.getElementById('chatPartnerName').textContent = chatName;
            document.getElementById('chatHeaderAvatar').innerHTML = avatarText;
            document.getElementById('statusText').textContent = data.type === 'direct' ? 'Online' : `${Object.keys(data.participants || {}).length} members`;
            
            // Load messages
            loadMessages(id);
            
            // Mark as read
            database.ref(`conversations/${id}/unreadCount/${currentUserId}`).set(0);
            
            // Update conversation item unread badge
            const conversationItem = document.querySelector(`.conversation-item[data-chat-id="${id}"] .conversation-unread`);
            if (conversationItem) {
                conversationItem.remove();
            }
        }

        function loadMessages(chatId) {
            database.ref(`messages/${chatId}`).orderByChild('timestamp').limitToLast(100).on('value', (snapshot) => {
                const messages = snapshot.val();
                const container = document.getElementById('messagesContainer');
                container.innerHTML = '';
                
                if (!messages) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px; color: var(--text-tertiary);">
                            <i class="fas fa-comments" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                            <p>No messages yet</p>
                            <p style="font-size: 13px; margin-top: 8px;">Start the conversation!</p>
                        </div>
                    `;
                    return;
                }
                
                // Group messages by date
                const messagesByDate = {};
                Object.values(messages).forEach(msg => {
                    const date = new Date(msg.timestamp).toDateString();
                    if (!messagesByDate[date]) messagesByDate[date] = [];
                    messagesByDate[date].push(msg);
                });
                
                // Display messages
                Object.entries(messagesByDate).forEach(([date, msgs]) => {
                    const dateDiv = document.createElement('div');
                    dateDiv.className = 'message-date';
                    dateDiv.innerHTML = `<span class="date-label">${new Date(date).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}</span>`;
                    container.appendChild(dateDiv);
                    
                    msgs.sort((a, b) => a.timestamp - b.timestamp).forEach(msg => {
                        const messageDiv = createMessageElement(msg);
                        container.appendChild(messageDiv);
                    });
                });
                
                // Scroll to bottom
                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                }, 100);
            });
        }

        function createMessageElement(msg) {
            const isSent = msg.senderId === currentUserId;
            const div = document.createElement('div');
            div.className = `message ${isSent ? 'sent' : 'received'}`;
            
            let content = '';
            if (msg.type === 'image') {
                content = `
                    <div class="message-bubble">
                        <img src="${msg.imageUrl}" alt="Shared image" style="max-width: 300px; border-radius: 12px; margin-top: 8px; cursor: pointer;" 
                             onclick="previewImage('${msg.imageUrl}')">
                        ${msg.text ? `<div class="message-text" style="margin-top: 8px;">${msg.text}</div>` : ''}
                    </div>
                `;
            } else if (msg.type === 'file') {
                content = `
                    <div class="message-bubble">
                        <div class="file-attachment" onclick="downloadFile('${msg.fileUrl}', '${msg.fileName}')">
                            <div class="file-icon">
                                <i class="fas ${getFileIcon(msg.fileType)}"></i>
                            </div>
                            <div class="file-info">
                                <div class="file-name">${msg.fileName}</div>
                                <div class="file-size">${formatFileSize(msg.fileSize)}</div>
                            </div>
                            <div class="file-download">
                                <i class="fas fa-download"></i>
                            </div>
                        </div>
                        ${msg.text ? `<div class="message-text" style="margin-top: 8px;">${msg.text}</div>` : ''}
                    </div>
                `;
            } else {
                content = `
                    <div class="message-bubble">
                        <div class="message-text">${msg.text}</div>
                    </div>
                `;
            }
            
            div.innerHTML = `
                ${!isSent ? `<div class="message-avatar">${getInitials(msg.senderInfo?.name)}</div>` : ''}
                <div class="message-content">
                    ${content}
                    <div class="message-time">
                        ${new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                        ${isSent && msg.read ? '<span style="margin-left: 4px; color: var(--accent-success);"><i class="fas fa-check-double"></i></span>' : ''}
                    </div>
                </div>
                ${isSent ? `<div class="message-avatar">${getInitials(currentUserInfo.name)}</div>` : ''}
            `;
            
            return div;
        }

        function getFileIcon(fileType) {
            if (fileType?.includes('pdf')) return 'fa-file-pdf';
            if (fileType?.includes('word')) return 'fa-file-word';
            if (fileType?.includes('excel')) return 'fa-file-excel';
            if (fileType?.includes('image')) return 'fa-file-image';
            if (fileType?.includes('video')) return 'fa-file-video';
            if (fileType?.includes('audio')) return 'fa-file-audio';
            if (fileType?.includes('zip')) return 'fa-file-archive';
            return 'fa-file';
        }

        function loadOnlineUsers() {
            database.ref('userStatus').orderByChild('status').equalTo('online').on('value', (snapshot) => {
                const users = snapshot.val();
                const container = document.getElementById('onlineUsersList');
                container.innerHTML = '';
                
                if (!users) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-tertiary);">
                            <p>No users online</p>
                        </div>
                    `;
                    return;
                }
                
                Object.entries(users).forEach(([id, data]) => {
                    if (id !== currentUserId) {
                        const userInfo = getUserInfo(data.email);
                        const div = document.createElement('div');
                        div.className = 'online-user-item';
                        div.innerHTML = `
                            <div class="online-user-avatar">
                                ${getInitials(userInfo.name)}
                                <div class="online-indicator"></div>
                            </div>
                            <div class="online-user-info">
                                <div class="online-user-name">${userInfo.name}</div>
                                <div class="online-user-role">${userInfo.role}</div>
                            </div>
                        `;
                        container.appendChild(div);
                    }
                });
                
                // Update online count
                const onlineCount = Object.keys(users).filter(id => id !== currentUserId).length;
                document.getElementById('welcomeOnlineCount').textContent = onlineCount;
            });
        }

        async function loadWorkspaceStats() {
            try {
                // Count messages
                const messagesSnapshot = await database.ref('messages').once('value');
                let totalMessages = 0;
                let totalFiles = 0;
                
                if (messagesSnapshot.val()) {
                    Object.values(messagesSnapshot.val()).forEach(chatMessages => {
                        if (chatMessages) {
                            Object.values(chatMessages).forEach(msg => {
                                totalMessages++;
                                if (msg.type === 'file' || msg.type === 'image') {
                                    totalFiles++;
                                }
                            });
                        }
                    });
                }
                
                // Count conversations
                const conversationsSnapshot = await database.ref('conversations').once('value');
                const activeConversations = conversationsSnapshot.val() ? Object.keys(conversationsSnapshot.val()).length : 0;
                
                // Update UI
                document.getElementById('welcomeMessageCount').textContent = totalMessages;
                document.getElementById('welcomeFileCount').textContent = totalFiles;
                document.getElementById('welcomeActiveCount').textContent = activeConversations;
                
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadRecentFiles() {
            try {
                const messagesSnapshot = await database.ref('messages').once('value');
                const recentFiles = [];
                
                if (messagesSnapshot.val()) {
                    Object.values(messagesSnapshot.val()).forEach(chatMessages => {
                        if (chatMessages) {
                            Object.values(chatMessages).forEach(msg => {
                                if (msg.type === 'file' || msg.type === 'image') {
                                    recentFiles.push({
                                        name: msg.fileName || 'File',
                                        type: msg.type,
                                        size: msg.fileSize || 0,
                                        timestamp: msg.timestamp,
                                        url: msg.fileUrl || msg.imageUrl
                                    });
                                }
                            });
                        }
                    });
                }
                
                // Sort and get latest 5
                recentFiles.sort((a, b) => b.timestamp - a.timestamp);
                const latestFiles = recentFiles.slice(0, 5);
                
                // Display
                const container = document.getElementById('recentFilesList');
                container.innerHTML = '';
                
                if (latestFiles.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--text-tertiary);">
                            <p>No files shared yet</p>
                        </div>
                    `;
                    return;
                }
                
                latestFiles.forEach(file => {
                    const div = document.createElement('div');
                    div.className = 'file-item';
                    div.onclick = () => {
                        if (file.type === 'image') {
                            previewImage(file.url);
                        } else {
                            downloadFile(file.url, file.name);
                        }
                    };
                    
                    const icon = file.type === 'image' ? 'fa-image' : 'fa-file';
                    div.innerHTML = `
                        <div class="file-item-icon">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div class="file-item-info">
                            <div class="file-item-name">${file.name}</div>
                            <div class="file-item-meta">
                                <span>${formatTime(file.timestamp)}</span>
                                ${file.size ? `<span> ${formatFileSize(file.size)}</span>` : ''}
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                });
                
            } catch (error) {
                console.error('Error loading recent files:', error);
            }
        }

        // ============================
        // FILE HANDLING FUNCTIONS
        // ============================
        function previewImage(url) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.right = '0';
            modal.style.bottom = '0';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.zIndex = '10002';
            
            modal.innerHTML = `
                <div style="background: var(--surface-color); border-radius: var(--border-radius); padding: 24px; max-width: 800px; width: 90%; max-height: 90vh; overflow: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="font-family: 'Plus Jakarta Sans', sans-serif; font-size: 20px; font-weight: 700; color: var(--text-primary);">Image Preview</h3>
                        <button onclick="this.closest('.modal-overlay').remove()" style="background: none; border: none; color: var(--text-tertiary); font-size: 20px; cursor: pointer;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div style="text-align: center;">
                        <img src="${url}" alt="Preview" style="max-width: 100%; max-height: 70vh; object-fit: contain; border-radius: 12px;">
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: center; margin-top: 24px;">
                        <button onclick="this.closest('.modal-overlay').remove()" style="padding: 10px 20px; border-radius: 10px; background: rgba(255, 255, 255, 0.05); color: var(--text-primary); border: 1px solid var(--border-color); cursor: pointer;">Close</button>
                        <button onclick="downloadFile('${url}', 'image.jpg')" style="padding: 10px 20px; border-radius: 10px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; border: none; cursor: pointer;">
                            <i class="fas fa-download"></i> Download
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function downloadFile(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Make functions globally available
        window.previewImage = previewImage;
        window.downloadFile = downloadFile;

        // Add CSS animation for notification badge
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.2); }
                100% { transform: scale(1); }
            }
        `;
        document.head.appendChild(style);

        // Handle page visibility change
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                // Page is visible again, update notifications
                loadNotifications();
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (currentUserId) {
                database.ref(`userStatus/${currentUserId}`).update({
                    status: 'offline',
                    lastSeen: Date.now()
                });
            }
        });
    </script>
</body>
</html>
